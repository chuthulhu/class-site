<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì²«ê±¸ìŒ, ë§ˆì§€ë§‰ ê±¸ìŒ í”„ë¡œì íŠ¸ - 1ì°¨ì‹œ</title>
    <meta name="submission-subject" content="ê³¼í•™íƒêµ¬ì‹¤í—˜2">
    <meta name="submission-activity" content="ìˆ˜í–‰3_1ì°¨ì‹œ">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Nanum+Myeongjo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR','Inter',sans-serif; background-color:#f3f4f6; }
        .tab-button-group { display:flex; flex-wrap:wrap; gap:0.5rem; background-color:#e5e7eb; padding:0.5rem; border-radius:0.75rem; }
        .tab-button { flex-grow:1; text-align:center; padding:0.75rem 0.5rem; border-radius:0.5rem; font-weight:500; color:#4b5563; cursor:pointer; transition:all .3s ease; border:2px solid transparent; }
        .tab-button:hover { background-color:#f9fafb; color:#1f2937; }
        .tab-button.active { background-color:#fff; color:#4f46e5; font-weight:700; box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06); }
        .tab-content { display:none; }
        .tab-content.active { display:block; }
        .report-page { background-color:#fff; padding:2.5cm 2cm; box-shadow:0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); color:#1f2937; }
        .report-main-title { font-family:'Noto Sans KR',sans-serif; font-size:1.875rem; font-weight:700; text-align:center; margin-bottom:1rem; border-bottom:2px solid #111827; padding-bottom:1rem; }
        .report-section-title { font-family:'Noto Sans KR',sans-serif; font-size:1.5rem; font-weight:700; color:#111827; margin-top:2.5rem; margin-bottom:1rem; padding-bottom:0.5rem; border-bottom:1px solid #d1d5db; }
        .preview-text { white-space:pre-wrap; word-break:break-word; min-height:2.5em; line-height:1.8; color:#374151; font-family:'Nanum Myeongjo',serif; }
        .preview-placeholder { color:#9ca3af; font-style:italic; }
        /* guidance styles */
        .infographic-card { background-color:#f9fafb; border:1px solid #e5e7eb; border-radius:0.75rem; padding:1.5rem; text-align:center; }
        .tip-card { background: linear-gradient(135deg,#f5f3ff,#eef2ff); border-left:4px solid #6366f1; padding:1rem; border-radius:0.5rem; }
        /* accordion */
        .accordion-header button.open { background-color:#eef2ff; color:#4338ca; }
        .accordion-content { transition:max-height .3s ease-out, padding .3s ease-out; max-height:0; overflow:hidden; }
        .accordion-content.open { max-height:1500px; }

        /* Responsive typography & controls */
        html { font-size:16px; }
        @media (min-width: 640px) { html { font-size:16.5px; } }
        @media (min-width: 768px) { html { font-size:17px; } }
        @media (min-width: 1024px) { html { font-size:17.5px; } }
        @media (min-width: 1280px) { html { font-size:18px; } }

        .tab-button { font-size:.95rem; padding:.85rem .5rem; }
        @media (min-width: 640px) { .tab-button { font-size:1rem; } }
        @media (min-width: 1024px) { .tab-button { font-size:1.05rem; } }

        #download_zip_btn,
        #print_btn,
        #preview_newtab_btn,
        #retry_upload_btn,
        #add_source_btn,
        #clear_inputs_btn {
            font-size:.95rem; padding:.6rem 1rem;
        }
        @media (min-width: 640px) {
            #download_zip_btn,
            #print_btn,
            #preview_newtab_btn,
            #retry_upload_btn,
            #add_source_btn,
            #clear_inputs_btn { font-size:1rem; padding:.7rem 1.1rem; }
        }
        @media (min-width: 1024px) {
            #download_zip_btn,
            #print_btn,
            #preview_newtab_btn,
            #retry_upload_btn,
            #add_source_btn,
            #clear_inputs_btn { font-size:1.0625rem; padding:.8rem 1.2rem; }
        }

        label { font-size:.95rem; }
        textarea, input[type="text"], input[type="number"], select { font-size:1rem; }
        @media (min-width: 1024px) {
            textarea, input[type="text"], input[type="number"], select { font-size:1.0625rem; }
        }
        @page { size:A4 portrait; margin:2cm; }
        @media print { body *{ visibility:hidden } .printable-area, .printable-area *{ visibility:visible } .printable-area{ position:absolute; left:0; top:0; width:100%; padding:0; margin:0; box-shadow:none; border:none } .no-print{ display:none } }
    </style>
    <link rel="icon" href="data:,">
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-5xl mx-auto">
        <header class="text-center bg-white p-8 rounded-xl shadow-lg mb-6 no-print">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">ì²«ê±¸ìŒ, ë§ˆì§€ë§‰ ê±¸ìŒ í”„ë¡œì íŠ¸ - 1ì°¨ì‹œ</h1>
            <p class="text-lg text-gray-600 mt-2">í˜„í™© ë¶„ì„ + ëŒ€ìƒì§€ ê³ ë ¤ì‚¬í•­ (ë¶€ë¶„ ì œì¶œ)</p>
            <div class="mt-4">
                <a href="./index.html" class="text-indigo-600 hover:underline">â† í™œë™ í—ˆë¸Œë¡œ ëŒì•„ê°€ê¸°</a>
            </div>
        </header>

        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-md mb-6 no-print">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-6">
                <div class="flex items-center space-x-2 flex-wrap justify-center">
                    <input type="number" id="student_grade" min="1" max="3" step="1" inputmode="numeric" class="w-20 p-2 border border-gray-300 rounded-md text-center" placeholder="í•™ë…„">
                    <label for="student_grade" class="font-semibold">í•™ë…„</label>
                    <input type="number" id="student_class" min="1" max="20" step="1" inputmode="numeric" class="w-20 p-2 border border-gray-300 rounded-md text-center" placeholder="ë°˜">
                    <label for="student_class" class="font-semibold">ë°˜</label>
                    <input type="number" id="student_number" min="1" max="40" step="1" inputmode="numeric" class="w-20 p-2 border border-gray-300 rounded-md text-center" placeholder="ë²ˆí˜¸">
                    <label for="student_number" class="font-semibold">ë²ˆ</label>
                    <input type="text" id="student_name" class="w-32 p-2 border border-gray-300 rounded-md" placeholder="ì´ë¦„">
                </div>
            </div>
        </div>

        <div class="mb-8 no-print">
            <div class="tab-button-group" aria-label="Tabs">
                <button class="tab-button active" data-tab="guide1">0. í™œë™ ì•ˆë‚´</button>
                <button class="tab-button" data-tab="tab4">1. í™œë™ì§€ ì‘ì„±</button>
                <button class="tab-button" data-tab="tab5">2. ë¯¸ë¦¬ë³´ê¸° ë° ì œì¶œ</button>
            </div>
        </div>
            <div id="guide1" class="tab-content active">
                <div class="bg-white p-6 sm:p-8 rounded-lg shadow-md space-y-10">
                    <section>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">S-BRT: ë¹›ê³¼ ê·¸ë¦¼ì</h2>
                        <p class="text-gray-600 mb-6">ì°½ì› S-BRT ë„ì…ì˜ ê¸ì •/ë¶€ì • íš¨ê³¼ë¥¼ ì´í•´í•˜ê³ , ë¬¸ì œì˜ì‹ì„ í˜•ì„±í•©ë‹ˆë‹¤.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="infographic-card"><span class="text-5xl mb-3">ğŸ“ˆ</span><h3 class="font-bold">ê¸ì •ì  íš¨ê³¼</h3><p class="text-gray-600 mt-2">ë²„ìŠ¤ í†µí–‰ì‹œê°„ ë‹¨ì¶•, ì´ìš©ê° ì¦ê°€ ë“±</p></div>
                            <div class="infographic-card"><span class="text-5xl mb-3">ğŸš—</span><h3 class="font-bold">ë¶€ì •ì  íš¨ê³¼</h3><p class="text-gray-600 mt-2">ìŠ¹ìš©ì°¨ í†µí–‰ì‹œê°„ ì¦ê°€ ë“±</p></div>
                        </div>
                    </section>
                    <section>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">1ì°¨ì‹œ ëª©í‘œ</h2>
                        <div class="tip-card">
                            <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
                                <li>í˜„í™© ë¶„ì„: ì™œ ì§€ê¸ˆ ì´ ë¬¸ì œê°€ ì¤‘ìš”í•œê°€?</li>
                                <li>ëŒ€ìƒì§€ ê³ ë ¤ì‚¬í•­: ìµœì†Œ 2ê°€ì§€ ê¸°ì¤€ê³¼ ì´ìœ  ì œì‹œ</li>
                            </ul>
                        </div>
                    </section>
                    <!-- Guide items 1~2 from hub -->
                    <section>
                        <div class="accordion-item border-t pt-4">
                            <div class="accordion-header"><button class="w-full text-left p-4 rounded-lg font-semibold text-lg text-gray-800 hover:bg-gray-100 flex justify-between items-center"><span>ğŸ“Š 1. 'í˜„í™© ë¶„ì„'ì€ ì–´ë–»ê²Œ í• ê¹Œ?</span><svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button></div>
                            <div class="accordion-content"><div class="p-4 text-gray-600 space-y-3">
                                <p>ì¢‹ì€ í•´ê²°ì±…ì€ ì •í™•í•œ ë¬¸ì œ ì¸ì‹ì—ì„œ ì‹œì‘ë©ë‹ˆë‹¤. ì™œ ì§€ê¸ˆ S-BRTì™€ ê³µìœ  PMì˜ ì—°ê³„ê°€ ì¤‘ìš”í•œ ë¬¸ì œì¸ì§€, ìµœì‹  ë‰´ìŠ¤ ê¸°ì‚¬ë‚˜ ìë£Œë¥¼ ì°¸ê³ í•˜ì—¬ ìì‹ ì˜ ì–¸ì–´ë¡œ ì •ë¦¬í•´ë³´ì„¸ìš”.</p>
                                <div class="tip-card p-4 rounded-lg">
                                    <h4 class="font-bold text-indigo-800">ìƒê°ì„ ë„“íˆëŠ” ì§ˆë¬¸</h4>
                                    <ul class="list-disc list-inside mt-2 text-sm">
                                        <li>ìµœê·¼ ì°½ì›ì‹œ S-BRTë‚˜ ê³µìœ  PMê³¼ ê´€ë ¨í•˜ì—¬ ì–´ë–¤ ë‰´ìŠ¤ë“¤ì´ ìˆì—ˆë‚˜ìš”?</li>
                                        <li>ì‹œë¯¼ë“¤ì€ ì´ ë¬¸ì œì— ëŒ€í•´ ì–´ë–¤ ë¶ˆí¸ì„ ê²ªê³  ìˆì„ê¹Œìš”?</li>
                                        <li>ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ì§€ ì•Šìœ¼ë©´ ë¯¸ë˜ì— ì–´ë–¤ ë” í° ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆì„ê¹Œìš”?</li>
                                    </ul>
                                </div>
                            </div></div>
                        </div>
                        <div class="accordion-item border-t pt-4">
                            <div class="accordion-header"><button class="w-full text-left p-4 rounded-lg font-semibold text-lg text-gray-800 hover:bg-gray-100 flex justify-between items-center"><span>ğŸ¤” 2. 'ëŒ€ìƒì§€ ì„ ì •ì„ ìœ„í•œ ê³ ë ¤ì‚¬í•­'ì€ ì–´ë–»ê²Œ ì •í• ê¹Œ?</span><svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button></div>
                            <div class="accordion-content"><div class="p-4 text-gray-600 space-y-3">
                                <p>ë§Œì•½ ì—¬ëŸ¬ë¶„ì´ ì°½ì›ì‹œì¥ì´ë¼ë©´, í•œì •ëœ ì˜ˆì‚°ìœ¼ë¡œ 'ìŠ¤ë§ˆíŠ¸ ëª¨ë¹Œë¦¬í‹° í—ˆë¸Œ'ë¥¼ ë”± í•œ ê³³ì—ë§Œ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤. ì–´ë–¤ ê¸°ì¤€ìœ¼ë¡œ ê·¸ ì¥ì†Œë¥¼ ê³¨ë¼ì•¼ ì‹œë²”ì‚¬ì—…ì´ ì„±ê³µí•˜ê³ , ì‹œë¯¼ë“¤ì—ê²Œ ê°€ì¥ í° ë„ì›€ì´ ë ê¹Œìš”? ê·¸ ê¸°ì¤€ì„ ì •í•˜ëŠ” ê²ƒì´ ì´ë²ˆ í™œë™ì˜ í•µì‹¬ì…ë‹ˆë‹¤.</p>
                                <div class="tip-card p-4 rounded-lg">
                                    <h4 class="font-bold text-indigo-800">ìƒê°ì„ ë„“íˆëŠ” ì§ˆë¬¸</h4>
                                    <ul class="list-disc list-inside mt-2 text-sm">
                                        <li>ëˆ„ê°€ í—ˆë¸Œë¥¼ ê°€ì¥ ë§ì´ ì´ìš©í• ê¹Œìš”? (í•™ìƒ, ì§ì¥ì¸, ì£¼ë¯¼ ë“±)</li>
                                        <li>ì–´ë–¤ ë¬¸ì œë¥¼ ê°€ì¥ ì‹œê¸‰í•˜ê²Œ í•´ê²°í•´ì•¼ í• ê¹Œìš”? (ì•ˆì „, ë¶ˆí¸, ë„ì‹œ ë¯¸ê´€ ë“±)</li>
                                        <li>ì–´ë””ì— ì„¤ì¹˜í•´ì•¼ ëˆˆì— ì˜ ë„ê³  ë” ë§ì€ ì‚¬ëŒì´ ì´ìš©í•  ìˆ˜ ìˆì„ê¹Œìš”?</li>
                                    </ul>
                                </div>
                            </div></div>
                        </div>
                    </section>
                </div>
            </div>

        <main>
            <div id="tab4" class="tab-content active">
                <div class="bg-white p-6 sm:p-10 rounded-lg shadow-md space-y-8">
                    <header class="text-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">1ì°¨ì‹œ í™œë™ì§€</h2>
                        <p class="text-gray-600">í˜„í™© ë¶„ì„ê³¼ ëŒ€ìƒì§€ ê³ ë ¤ì‚¬í•­ì„ ì‘ì„±í•˜ì„¸ìš”.</p>
                    </header>
                    <div class="flex justify-end -mt-2">
                        <button id="clear_inputs_btn" class="bg-red-50 text-red-700 font-semibold py-2 px-4 rounded-lg border border-red-200 hover:bg-red-100 transition text-sm">ğŸ—‘ï¸ ì…ë ¥ ë‚´ìš© ì‚­ì œ</button>
                    </div>
                    
                    <section>
                        <h3 class="text-xl font-bold text-indigo-700 mb-4">1. í˜„í™© ë¶„ì„ ë° ë¬¸ì œ ì¸ì‹</h3>
                        <div>
                            <label for="field_analysis" class="font-semibold text-gray-700 block mb-2">S-BRTì™€ ê³µìœ  PM ì—°ê³„ ë¬¸ì œì˜ í˜„í™©ê³¼ ì¤‘ìš”ì„±</label>
                            <div class="text-sm bg-blue-50 border border-blue-200 text-blue-900 rounded-md p-3 mb-2">
                                <div class="font-semibold mb-1">í‰ê°€ ê¸°ì¤€</div>
                                <ul class="list-disc list-inside space-y-0.5">
                                    <li>ì¶œì²˜ê°€ í™•ì¸ë˜ëŠ” ì™¸ë¶€ìë£Œë¥¼ 1ê°€ì§€ ì´ìƒ í¬í•¨</li>
                                    <li>ë¬¸ì œ í•´ê²°ì˜ ì‹œê¸‰ì„±ê³¼ í•„ìš”ì„±ì„ ëª¨ë‘ ì„œìˆ </li>
                                </ul>
                            </div>
                            <textarea id="field_analysis" rows="6" class="w-full p-3 border border-gray-300 rounded-md" placeholder="ìµœì‹  ë‰´ìŠ¤ë‚˜ ìë£Œë¥¼ ì°¸ê³ í•˜ì—¬, í˜„ì¬ ì°½ì›ì‹œì˜ S-BRTì™€ ê³µìœ  PM ì—°ê³„ ë¬¸ì œê°€ ì™œ ì¤‘ìš”í•˜ê³  ì‹œê¸‰í•œì§€ ìì‹ ì˜ ì–¸ì–´ë¡œ ë¶„ì„í•˜ì—¬ ì‘ì„±í•´ë³´ì„¸ìš”."></textarea>
                        </div>
                    </section>
                    <section>
                        <h3 class="text-xl font-bold text-indigo-700 mb-4">2. ì‹œë²”ì‚¬ì—… ëŒ€ìƒì§€ ì„ ì •ì„ ìœ„í•œ ê³ ë ¤ì‚¬í•­</h3>
                        <div class="space-y-6">
                            <div class="border border-gray-200 rounded-lg p-4 bg-white">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div class="md:col-span-1">
                                        <label for="field_c1_title" class="font-semibold text-gray-700 block mb-2">ê³ ë ¤ì‚¬í•­ 1</label>
                                        <input type="text" id="field_c1_title" class="w-full p-3 border border-gray-300 rounded-md" placeholder="í•œ ë¬¸ì¥ìœ¼ë¡œ í•µì‹¬ ê¸°ì¤€ì„ ì‘ì„±">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="field_c1_desc" class="font-semibold text-gray-700 block mb-2">ì´ìœ (ê·¼ê±°)</label>
                                        <textarea id="field_c1_desc" rows="4" class="w-full p-3 border border-gray-300 rounded-md" placeholder="ì™œ ì´ ê¸°ì¤€ì´ ì¤‘ìš”í•œê°€ìš”? ë°ì´í„°Â·ì‚¬ë¡€ ë“± êµ¬ì²´ì  ê·¼ê±°ë¥¼ ë“¤ì–´ ì„¤ëª…"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="border border-gray-200 rounded-lg p-4 bg-white">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div class="md:col-span-1">
                                        <label for="field_c2_title" class="font-semibold text-gray-700 block mb-2">ê³ ë ¤ì‚¬í•­ 2</label>
                                        <input type="text" id="field_c2_title" class="w-full p-3 border border-gray-300 rounded-md" placeholder="í•œ ë¬¸ì¥ìœ¼ë¡œ í•µì‹¬ ê¸°ì¤€ì„ ì‘ì„±">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="field_c2_desc" class="font-semibold text-gray-700 block mb-2">ì´ìœ (ê·¼ê±°)</label>
                                        <textarea id="field_c2_desc" rows="4" class="w-full p-3 border border-gray-300 rounded-md" placeholder="ì™œ ì´ ê¸°ì¤€ì´ ì¤‘ìš”í•œê°€ìš”? ë°ì´í„°Â·ì‚¬ë¡€ ë“± êµ¬ì²´ì  ê·¼ê±°ë¥¼ ë“¤ì–´ ì„¤ëª…"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                    <section>
                        <h3 class="text-xl font-bold text-indigo-700 mb-4">3. ì •ë³´ ì¶œì²˜</h3>
                        <div>
                            <div class="text-sm text-gray-600 mb-2">í˜„í™© ë¶„ì„ì— ì‚¬ìš©í•œ ì™¸ë¶€ìë£Œì˜ ì¶œì²˜ë¥¼ <strong>ìµœì†Œ 1ê°œ ì´ìƒ</strong> ê¸°ì¬í•˜ì„¸ìš”.</div>
                            <div id="sources_container" class="space-y-4"></div>
                            <button id="add_source_btn" class="mt-2 bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition text-sm">+ ì¶œì²˜ ì¶”ê°€</button>
                        </div>
                    </section>
                </div>
            </div>

            <div id="tab5" class="tab-content">
                <div class="bg-white p-6 sm:p-8 rounded-lg shadow-md mb-6 no-print">
                    <div class="flex justify-center items-center gap-4 flex-wrap">
                        <button id="download_zip_btn" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition text-base">ğŸ“¦ ZIPìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ</button>
                        <button id="print_btn" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition text-base">ğŸ–¨ï¸ PDFë¡œ ì €ì¥</button>
                        <button id="preview_newtab_btn" class="bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition text-base">ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°(ìƒˆ íƒ­)</button>
                        <button id="retry_upload_btn" class="hidden bg-yellow-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-yellow-600 transition text-base">ğŸ”„ ì—…ë¡œë“œ ì¬ì‹œë„</button>
                    </div>
                    <p class="text-center text-sm text-gray-600 mt-4" aria-live="polite" role="status"><span id="submit_status"></span></p>
                    <div id="progress_container" class="w-full max-w-xl mx-auto mt-3 hidden" aria-hidden="true">
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div id="progress_bar" class="bg-indigo-600 h-3 rounded-full" style="width:0%"></div>
                        </div>
                        <p id="progress_text" class="text-center text-xs text-gray-600 mt-1"></p>
                    </div>
                </div>
                <div class="bg-gray-200 p-4 sm:p-8 rounded-lg">
                    <div class="printable-area report-page" id="report-content">
                        <h1 id="preview_main_title" class="report-main-title">ìŠ¤ë§ˆíŠ¸ ëª¨ë¹Œë¦¬í‹° í—ˆë¸Œ ì•„ì´ë””ì–´ ì œì•ˆì„œ (1ì°¨ì‹œ)</h1>
                        <p class="text-right text-gray-600 mb-10" style="font-family: 'Noto Sans KR', sans-serif;">
                            <span id="preview_student_grade">1</span>í•™ë…„ <span id="preview_student_class">0</span>ë°˜ <span id="preview_student_number">00</span>ë²ˆ ì´ë¦„: <span id="preview_student_name">ã…‡ã…‡ã…‡</span>
                        </p>
                        <h2 class="report-section-title">I. í˜„í™© ë¶„ì„ ë° ë¬¸ì œ ì¸ì‹</h2>
                        <p class="preview-text" id="preview_analysis"><span class="preview-placeholder">ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...</span></p>
                        <h2 class="report-section-title">II. ì‹œë²”ì‚¬ì—… ëŒ€ìƒì§€ ì„ ì •ì„ ìœ„í•œ ê³ ë ¤ì‚¬í•­</h2>
                        <div class="border border-gray-300 rounded-md p-3 mb-3">
                            <div class="font-semibold mb-1" id="preview_c1_title" style="font-family: 'Noto Sans KR', sans-serif;"><span class="preview-placeholder">[ê³ ë ¤ì‚¬í•­ 1 ì œëª©]</span></div>
                            <div class="text-sm text-gray-600 mb-1">ì´ìœ (ê·¼ê±°)</div>
                            <p class="preview-text" id="preview_c1_desc"><span class="preview-placeholder">ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...</span></p>
                        </div>
                        <div class="border border-gray-300 rounded-md p-3">
                            <div class="font-semibold mb-1" id="preview_c2_title" style="font-family: 'Noto Sans KR', sans-serif;"><span class="preview-placeholder">[ê³ ë ¤ì‚¬í•­ 2 ì œëª©]</span></div>
                            <div class="text-sm text-gray-600 mb-1">ì´ìœ (ê·¼ê±°)</div>
                            <p class="preview-text" id="preview_c2_desc"><span class="preview-placeholder">ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...</span></p>
                        </div>
                        <h2 class="report-section-title">V. ì •ë³´ ì¶œì²˜</h2>
                        <div class="preview-text" id="preview_sources"><span class="preview-placeholder">ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...</span></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast-notification" class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 no-print">ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const dom = {
            tabs: document.querySelectorAll('.tab-button'),
            tabContents: document.querySelectorAll('.tab-content'),
            accordions: document.querySelectorAll('.accordion-header button'),
            downloadZipBtn: document.getElementById('download_zip_btn'),
            printBtn: document.getElementById('print_btn'),
            previewNewTabBtn: document.getElementById('preview_newtab_btn'),
            retryUploadBtn: document.getElementById('retry_upload_btn'),
            addSourceBtn: document.getElementById('add_source_btn'),
            sourcesContainer: document.getElementById('sources_container'),
            toast: document.getElementById('toast-notification'),
            allInputs: document.querySelectorAll('#tab4 input, #tab4 textarea, input#student_grade, input#student_class, input#student_number, input#student_name'),
            clearBtn: document.getElementById('clear_inputs_btn'),
            submitStatus: document.getElementById('submit_status'),
        };

        const fields = {
            'student_grade': 'preview_student_grade',
            'student_class': 'preview_student_class', 'student_number': 'preview_student_number', 'student_name': 'preview_student_name',
            'field_analysis': 'preview_analysis',
            'field_c1_title': 'preview_c1_title', 'field_c1_desc': 'preview_c1_desc',
            'field_c2_title': 'preview_c2_title', 'field_c2_desc': 'preview_c2_desc',
        };

        const storageKey = 'firstLastMileProjectData_session1';

        dom.tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));
        if (dom.accordions) dom.accordions.forEach(button => button.addEventListener('click', toggleAccordion));
        dom.allInputs.forEach(input => input.addEventListener('input', updatePreviewAndSave));
        if (dom.addSourceBtn) dom.addSourceBtn.addEventListener('click', () => addSourceElement());
        if (dom.sourcesContainer) {
            dom.sourcesContainer.addEventListener('click', (e) => { if (e.target.classList.contains('delete_source_btn')) { e.target.closest('.source-entry').remove(); updatePreviewAndSave(); } });
            dom.sourcesContainer.addEventListener('change', (e) => { if (e.target.classList.contains('source-type-select')) { updateSourceInputs(e.target); updatePreviewAndSave(); } });
            dom.sourcesContainer.addEventListener('input', updatePreviewAndSave);
        }

        if (dom.downloadZipBtn) dom.downloadZipBtn.addEventListener('click', handleZipDownloadAndSubmit);
        if (dom.printBtn) dom.printBtn.addEventListener('click', printReport);
        if (dom.previewNewTabBtn) dom.previewNewTabBtn.addEventListener('click', openPreviewInNewTab);
        if (dom.retryUploadBtn) dom.retryUploadBtn.addEventListener('click', retryLastUpload);
        if (dom.clearBtn) dom.clearBtn.addEventListener('click', handleClearAll);

        loadFromBrowser();
        switchTab('guide1');
        updatePreview();

        function switchTab(targetTabId) { dom.tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === targetTabId)); dom.tabContents.forEach(content => content.classList.toggle('active', content.id === targetTabId)); window.scrollTo(0,0); }
        function toggleAccordion(event) { const button = event.currentTarget; const content = button.parentElement.nextElementSibling; const icon = button.querySelector('svg'); const isOpen = button.classList.toggle('open'); content.classList.toggle('open', isOpen); if (isOpen) { content.style.maxHeight = content.scrollHeight + 'px'; content.style.paddingTop = '1rem'; content.style.paddingBottom = '1rem'; if(icon) icon.style.transform = 'rotate(180deg)'; } else { content.style.maxHeight = '0'; content.style.paddingTop = '0'; content.style.paddingBottom = '0'; if(icon) icon.style.transform = 'rotate(0deg)'; } }
        function updatePreviewAndSave() { updatePreview(); saveToBrowser(); }
        function updatePreview() { Object.entries(fields).forEach(([fieldId, previewId]) => { const inputEl = document.getElementById(fieldId); const previewEl = document.getElementById(previewId); if (!inputEl || !previewEl) return; const value = inputEl.value.trim(); const placeholderSpan = previewEl.querySelector('.preview-placeholder'); const placeholderText = placeholderSpan ? placeholderSpan.textContent : `[${fieldId}]`; if (value) { previewEl.textContent = value; } else { previewEl.innerHTML = `<span class="preview-placeholder">${placeholderText}</span>`; } }); updateSourcesPreview(); }
        function getFormData() { const data = {}; dom.allInputs.forEach(input => data[input.id] = input.value); data.sources = Array.from(document.querySelectorAll('.source-entry')).map(entry => ({ type: entry.dataset.type, values: Array.from(entry.querySelectorAll('input')).map(input => input.value) })); return data; }
        function saveToBrowser() { localStorage.setItem(storageKey, JSON.stringify(getFormData())); showToast('ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
        function loadFromBrowser() { const saved = localStorage.getItem(storageKey); if (!saved) return; const data = JSON.parse(saved); Object.entries(data).forEach(([k,v]) => { if (k === 'sources' && Array.isArray(v)) { v.forEach(s => addSourceElement(s)); } else { const el = document.getElementById(k); if (el) el.value = v; } }); updatePreview(); }
        function showToast(message) { const toast = dom.toast; if (!toast) return; toast.textContent = message; toast.style.opacity = 1; setTimeout(()=>{ toast.style.opacity = 0; }, 1200); }
        function handleClearAll(){ try{ const ok=window.confirm('ì…ë ¥í•œ ë‚´ìš©ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ì–´ìš”?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); if(!ok) return; clearFormAndStorage(); showToast('ì…ë ¥ ë‚´ìš©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); }catch(_){} }
        function clearFormAndStorage(){ try{ localStorage.removeItem(storageKey); localStorage.removeItem(SUBMIT_META_KEY); }catch(_){} Array.from(dom.allInputs).forEach(el=>{ if(el.tagName==='INPUT' || el.tagName==='TEXTAREA'){ el.value=''; } }); if(dom.sourcesContainer){ dom.sourcesContainer.innerHTML=''; } if(dom.retryUploadBtn){ dom.retryUploadBtn.classList.add('hidden'); dom.retryUploadBtn.dataset.show=''; } if (typeof lastZipBlob!=='undefined') lastZipBlob=null; if (typeof lastMeta!=='undefined') lastMeta=null; setStatus(''); updatePreview(); }
        function updateSourcesPreview() { const sourcesPreview = document.getElementById('preview_sources'); const entries = document.querySelectorAll('.source-entry'); if (!sourcesPreview) return; if (entries.length === 0) { sourcesPreview.innerHTML = `<span class="preview-placeholder">ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...</span>`; return; } let items = []; entries.forEach(entry => { const values = Array.from(entry.querySelectorAll('input')).map(i => escapeHtml(i.value.trim())); let parts = []; switch(entry.dataset.type){ case 'ë…¼ë¬¸': if(values[0]) parts.push(values[0]); if(values[1]) parts.push(`(${values[1]})`); if(values[2]) parts.push(`${values[2]}.`); if(values[3]) parts.push(values[3]); break; case 'ë„ì„œ': if(values[0]) parts.push(values[0]); if(values[3]) parts.push(`(${values[3]})`); if(values[1]) parts.push(`${values[1]}.`); if(values[2]) parts.push(values[2]); break; case 'í•™ìˆ ì¡ì§€': if(values[2]) parts.push(values[2]); if(values[3]) parts.push(`(${values[3]})`); if(values[1]) parts.push(`${values[1]}.`); if(values[0]) parts.push(values[0]); break; case 'ì¸í„°ë„· URL': if(values[2]) parts.push(values[2]); if(values[0]) parts.push(values[0]); if(values[1]) parts.push(`'${values[1]}'.`); if(values[3]) parts.push(`URL: ${values[3]}`); break; } let li = parts.join(' ').replace(/\s\./g,'.').replace(/\s,/g,','); items.push(`<li>${li}</li>`); }); sourcesPreview.innerHTML = `<ol class="list-decimal list-inside" style="line-height:1.8;">${items.join('')}</ol>`; }
        function escapeHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;');}

        function addSourceElement(sourceData=null){ const entryDiv=document.createElement('div'); entryDiv.className='source-entry border p-4 rounded-md bg-gray-50 space-y-3'; const type=sourceData?.type||'ë…¼ë¬¸'; entryDiv.dataset.type=type; entryDiv.innerHTML=`<div class="flex justify-between items-center"><select class="source-type-select p-2 border border-gray-300 rounded-md bg-white"><option ${type==='ë…¼ë¬¸'?'selected':''}>ë…¼ë¬¸</option><option ${type==='ë„ì„œ'?'selected':''}>ë„ì„œ</option><option ${type==='í•™ìˆ ì¡ì§€'?'selected':''}>í•™ìˆ ì¡ì§€</option><option ${type==='ì¸í„°ë„· URL'?'selected':''}>ì¸í„°ë„· URL</option></select><button class="delete_source_btn bg-red-500 text-white font-bold py-1 px-3 rounded-lg hover:bg-red-600 text-sm">ì‚­ì œ</button></div><div class="source-inputs grid grid-cols-1 sm:grid-cols-2 gap-2"></div>`; dom.sourcesContainer.appendChild(entryDiv); updateSourceInputs(entryDiv.querySelector('.source-type-select'), sourceData?.values); }
        function updateSourceInputs(selectElement, values=null){ const inputsContainer=selectElement.closest('.source-entry').querySelector('.source-inputs'); const type=selectElement.value; selectElement.closest('.source-entry').dataset.type=type; const fields = (type==='ë…¼ë¬¸')?['ì €ì*','ì—°ë„*','ë…¼ë¬¸ ì œëª©*','í•™ìˆ ì§€ëª…','ê¶Œ','í˜¸','í˜ì´ì§€']: (type==='ë„ì„œ')?['ì €ì*','ë„ì„œëª…*','ì¶œíŒì‚¬*','ì—°ë„']: (type==='í•™ìˆ ì¡ì§€')?['ì¡ì§€ëª…*','ê¸°ì‚¬ ì œëª©*','ê¸°ìëª…*','ë°œí–‰ì¼']: ['ì›¹ì‚¬ì´íŠ¸ëª…*','ê¸€ ì œëª©*','ì‘ì„±ì(ê¸°ì)*','URL*']; let i=0; inputsContainer.innerHTML = fields.map(label=>{ const required=label.endsWith('*'); const name=label.replace('*',''); const val=values?.[i++]||''; return `<label class="block"><span class="text-gray-700 text-sm">${name}${required?'<span class="text-red-500">*</span>':''}</span><input type="text" placeholder="${name}" value="${val}" class="w-full p-2 mt-1 border border-gray-300 rounded-md text-sm"></label>`; }).join(''); }

        function getReportFilename(){ const grade=(document.getElementById('student_grade').value||'1').trim(); const studentClass=(document.getElementById('student_class').value||'0').trim().padStart(2,'0'); const studentNumber=(document.getElementById('student_number').value||'0').trim().padStart(2,'0'); const studentId=`${grade}${studentClass}${studentNumber}`; const studentName=document.getElementById('student_name').value.trim()||'ì´ë¦„ì—†ìŒ'; return `${studentId}_${studentName}_ìŠ¤ë§ˆíŠ¸ëª¨ë¹Œë¦¬í‹°_ì œì•ˆì„œ_1ì°¨ì‹œ`; }
        function printReport(){ const originalTitle=document.title; document.title=getReportFilename(); window.print(); setTimeout(()=>{ document.title=originalTitle; }, 500); }
        function openPreviewInNewTab(){ try{ const reportContent=document.getElementById('report-content').innerHTML; const now=new Date(); const ts=`${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}`; const title=`ë¯¸ë¦¬ë³´ê¸°-1ì°¨ì‹œ-${ts}`; const docHtml=generateDocHtml(title, reportContent); const blob=new Blob([docHtml],{type:'text/html'}); const url=URL.createObjectURL(blob); window.open(url,'_blank'); setTimeout(()=>URL.revokeObjectURL(url),10000);}catch(_){}}

        function setStatus(text){ if (dom.submitStatus) dom.submitStatus.textContent=text||''; }
        function showProgress(show){ const c=document.getElementById('progress_container'); if(!c) return; c.classList.toggle('hidden', !show); c.setAttribute('aria-hidden', show?'false':'true'); }
        function setProgress(percent,label=''){ const bar=document.getElementById('progress_bar'); const txt=document.getElementById('progress_text'); if(bar) bar.style.width=`${Math.max(0,Math.min(100,percent))}%`; if(txt) txt.textContent=label||''; }

        const ENDPOINT='/.netlify/functions/submit';
        const SUBMIT_KEY='S-2025-github2025subject';
        const SUBJECT=document.querySelector('meta[name="submission-subject"]')?.content||'ê³¼í•™íƒêµ¬ì‹¤í—˜2';
        const ACTIVITY_INPUT_DEFAULT=document.querySelector('meta[name="submission-activity"]')?.content||'ìˆ˜í–‰3_1ì°¨ì‹œ';
        const SUBMIT_META_KEY='submit_meta_session1';

        ['student_grade','student_class','student_number','student_name'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('input', saveSubmitMeta); });
        loadSubmitMeta();
        function saveSubmitMeta(){ const meta={ grade:document.getElementById('student_grade')?.value||'', class:document.getElementById('student_class')?.value||'', number:document.getElementById('student_number')?.value||'', name:document.getElementById('student_name')?.value||'' }; try{ localStorage.setItem(SUBMIT_META_KEY, JSON.stringify(meta)); }catch(_){} }
        function loadSubmitMeta(){ try{ const raw=localStorage.getItem(SUBMIT_META_KEY); if(!raw) return; const meta=JSON.parse(raw); if(meta.grade!=null) document.getElementById('student_grade').value=meta.grade; if(meta.class!=null) document.getElementById('student_class').value=meta.class; if(meta.number!=null) document.getElementById('student_number').value=meta.number; if(meta.name!=null) document.getElementById('student_name').value=meta.name; }catch(_){} }

        function generateDocHtml(dynamicTitle, reportInnerHtml){ return `<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${dynamicTitle}</title><script src="https://cdn.tailwindcss.com"><\/script><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Nanum+Myeongjo:wght@400;700&display=swap" rel="stylesheet"><style>body{font-family:'Noto Sans KR','Inter',sans-serif;background-color:#f3f4f6;margin:0}*{color:inherit !important}.report-page{background-color:#fff;padding:2.5cm 2cm;box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);color:#1f2937}.printable-area{width:100%}.report-main-title{font-family:'Noto Sans KR',sans-serif;font-size:1.875rem;font-weight:700;text-align:center;margin-bottom:1rem;border-bottom:2px solid #111827;padding-bottom:1rem}.report-section-title{font-family:'Noto Sans KR',sans-serif;font-size:1.5rem;font-weight:700;color:#111827;margin-top:2.5rem;margin-bottom:1rem;padding-bottom:.5rem;border-bottom:1px solid #d1d5db}.preview-text{white-space:pre-wrap;word-break:break-word;min-height:2.5em;line-height:1.8;color:#374151;font-family:'Nanum Myeongjo',serif}.preview-placeholder{color:#9ca3af !important;font-style:italic}@page{size:A4 portrait;margin:2cm}@media print{body *{visibility:hidden}.printable-area,.printable-area *{visibility:visible}.printable-area{position:absolute;left:0;top:0;width:100%;padding:0;margin:0;box-shadow:none;border:none}.no-print{display:none}}</style></head><body><div class="report-page"><div class="printable-area">${reportInnerHtml}</div></div></body></html>`; }

        function calcSectionCode(grade,klass){ const g=String(grade||'').trim(); const k=String(klass||'').trim().padStart(2,'0'); return `${g}${k}`; }
        function calcStudentId(grade,klass,number){ const g=String(grade||'').trim(); const k=String(klass||'').trim().padStart(2,'0'); const n=String(number||'').trim().padStart(2,'0'); return `${g}${k}${n}`; }

        function validateForm(){ const gradeEl=document.getElementById('student_grade'); const classEl=document.getElementById('student_class'); const numberEl=document.getElementById('student_number'); const nameEl=document.getElementById('student_name'); const grade=parseInt((gradeEl.value||'').trim(),10); const klass=parseInt((classEl.value||'').trim(),10); const number=parseInt((numberEl.value||'').trim(),10); const name=(nameEl.value||'').trim(); if(Number.isNaN(grade)||grade<1||grade>3){ showToast('í•™ë…„ì€ 1~3 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.'); gradeEl.focus(); return null; } if(Number.isNaN(klass)||klass<1||klass>20){ showToast('ë°˜ì€ 1~20 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.'); classEl.focus(); return null; } if(Number.isNaN(number)||number<1||number>40){ showToast('ë²ˆí˜¸ëŠ” 1~40 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.'); numberEl.focus(); return null; } if(!name){ showToast('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); nameEl.focus(); return null; } return { grade, klass, number, name }; }

        async function blobToBase64(blob){ return await new Promise((resolve,reject)=>{ const reader=new FileReader(); reader.onload=()=>{ const result=reader.result||''; const commaIdx=String(result).indexOf(','); const b64=commaIdx>=0?String(result).slice(commaIdx+1):String(result); resolve(b64); }; reader.onerror=()=>reject(reader.error); reader.readAsDataURL(blob); }); }
        function bytesFromBase64(b64){ const len=b64.length; const pad=(b64.endsWith('==')?2:(b64.endsWith('=')?1:0)); return Math.floor((len*3)/4)-pad; }

        function triggerBlobDownload(blob, filename){ try{ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href); showToast('ZIP íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.'); return true; }catch(_){ return false; } }
        async function saveWithPicker(blob, filename){ try{ const opts={ suggestedName: filename, types:[{ description:'ZIP file', accept:{'application/zip':['.zip']} }] }; const handle=await window.showSaveFilePicker(opts); const writable=await handle.createWritable(); await writable.write(blob); await writable.close(); return true; }catch(_){ return false; } }
        function detectInApp(){ const uaRaw=navigator.userAgent||navigator.vendor||''; const ua=uaRaw.toLowerCase(); const isIOS=/iphone|ipad|ipod/.test(ua)||(navigator.platform==='MacIntel'&&navigator.maxTouchPoints>1); const isAndroid=/android/.test(ua); const isSamsung=/samsungbrowser/i.test(uaRaw); const isKakao=/kakaotalk/.test(ua); const isNaver=/naver/.test(ua); const isFB=/fban|fbav|fb_iab/.test(ua); const isIG=/instagram/.test(ua); const isLine=/ line\//.test(ua); const isIOSWebView=isIOS && !!window.webkit && !!window.webkit.messageHandlers && !/safari/i.test(uaRaw); const isInApp=isKakao||isNaver||isFB||isIG||isLine||isIOSWebView; return { isInApp, isIOS, isAndroid, isSamsung }; }

        async function attemptLocalDownloadAndVerify(zipFilename){ const env=detectInApp(); if (env.isInApp){ setStatus('ë¡œì»¬ ë‹¤ìš´ë¡œë“œê°€ ì œí•œë˜ì–´ ì„œë²„ ë‹¤ìš´ë¡œë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤.'); serverDownloadLastZip(); return; } if (env.isIOS){ setStatus('iOS ì €ì¥ ì•ˆë‚´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.'); // ê°„ì†Œí™”: iOS ê³µìœ  ì‹œíŠ¸ ëŒ€ì‹  ê¸°ë³¸ ë‹¤ìš´ë¡œë“œ ì‹œë„
            if (lastZipBlob) triggerBlobDownload(lastZipBlob, zipFilename); return; }
            let localSaved=false; let usedPicker=false; if (window.showSaveFilePicker && lastZipBlob){ usedPicker=true; localSaved=await saveWithPicker(lastZipBlob, zipFilename); }
            if (!localSaved && lastZipBlob){ try{ localSaved=triggerBlobDownload(lastZipBlob, zipFilename)===true; }catch(_){ localSaved=false; } }
            if (env.isAndroid || env.isSamsung){ if (!usedPicker) localSaved=false; }
            if (localSaved){ setStatus('âœ… ë¡œì»¬ ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'); showToast('ë¡œì»¬ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ'); } else { setStatus('ë¡œì»¬ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ ë˜ëŠ” ì œí•œë¨, ì„œë²„ì—ì„œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.'); serverDownloadLastZip(); }
        }

        function trackServerDownload(token, timeoutMs=5000){ const deadline=Date.now()+timeoutMs; const key=`download_ok_${encodeURIComponent(token)}=`; const timer=setInterval(()=>{ const found=document.cookie.includes(key); if (found){ clearInterval(timer); setStatus('âœ… ë¡œì»¬ ì €ì¥(ì„œë²„ ì²¨ë¶€) í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.'); showToast('ë‹¤ìš´ë¡œë“œ ì™„ë£Œ í™•ì¸'); } else if (Date.now()>deadline){ clearInterval(timer); } }, 300); }

        function serverDownloadLastZip(){ try{ if (!lastZipBlob || !lastMeta?.zipFilename){ showToast('ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.'); return; } blobToBase64(lastZipBlob).then((b64)=>{ const token=`${Date.now()}_${Math.random().toString(36).slice(2,8)}`; trackServerDownload(token, 3500); const form=document.createElement('form'); form.method='POST'; form.action='/.netlify/functions/download'; form.target='_blank'; const add=(n,v)=>{ const i=document.createElement('input'); i.type='hidden'; i.name=n; i.value=v; form.appendChild(i); }; add('filename', lastMeta.zipFilename); add('mime', 'application/zip'); add('contentBase64', b64); add('token', token); document.body.appendChild(form); form.submit(); document.body.removeChild(form); showToast('ì„œë²„ì—ì„œ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.'); }).catch(()=>{ throw new Error('base64 ë³€í™˜ ì‹¤íŒ¨'); }); }catch(_){ showToast('ì„œë²„ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
        }

        let lastZipBlob=null; let lastMeta=null;

        async function handleZipDownloadAndSubmit(){ try{
            setStatus('í•™ìƒ ì •ë³´ ê²€ì¦ ì¤‘â€¦'); dom.retryUploadBtn.dataset.show=''; dom.retryUploadBtn.classList.add('hidden'); const form=validateForm(); if(!form) return; showProgress(true); setProgress(10,'ë¬¸ì„œ ìƒì„± ì¤€ë¹„...');
            const section=calcSectionCode(form.grade, form.klass); const studentId=calcStudentId(form.grade, form.klass, form.number); const docTitle='ìŠ¤ë§ˆíŠ¸ ëª¨ë¹Œë¦¬í‹° í—ˆë¸Œ ì•„ì´ë””ì–´ ì œì•ˆì„œ (1ì°¨ì‹œ)';
            const fmt=new Intl.DateTimeFormat('ko-KR',{ timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false });
            const parts=Object.fromEntries(fmt.formatToParts(new Date()).map(p=>[p.type,p.value])); const timestamp=`${parts.year}${parts.month}${parts.day}_${parts.hour}${parts.minute}${parts.second}`;
            const baseName=`${studentId}_${form.name}_${docTitle}_${timestamp}`; const htmlFilename=`${baseName}.html`; const zipFilename=`${baseName}.zip`;
            setStatus('ZIP íŒŒì¼ ìƒì„± ì¤‘â€¦'); setProgress(25,'ZIP ìƒì„± ì¤‘...'); const reportContent=document.getElementById('report-content').innerHTML; const docHtml=generateDocHtml(baseName, reportContent);
            const zip=new JSZip(); zip.file(htmlFilename, docHtml); const zipBlob=await zip.generateAsync({type:'blob', compression:'DEFLATE', compressionOptions:{level:6}}); lastZipBlob=zipBlob; lastMeta={ studentId, name:form.name, zipFilename, section };
            const sizeBytes=zipBlob.size; if (sizeBytes>8*1024*1024){ setStatus('ì—…ë¡œë“œ ì‹¤íŒ¨: ZIP ìš©ëŸ‰ ì´ˆê³¼ (8MB)'); showToast('ZIP ìš©ëŸ‰ì´ 8MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.'); dom.retryUploadBtn.dataset.show='1'; dom.retryUploadBtn.classList.remove('hidden'); return; }
            setStatus('ì €ì¥ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”'); setProgress(45,'ì—…ë¡œë“œ ì¤€ë¹„...'); const b64=await blobToBase64(zipBlob);
            if (!zipFilename.toLowerCase().endsWith('.zip')){ setStatus('ì—…ë¡œë“œ ì‹¤íŒ¨: ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹'); showToast('ZIP íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); return; }
            const activity=(ACTIVITY_INPUT_DEFAULT||'').trim();
            if(!activity){ setStatus('í™œë™ í´ë”ëª…ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ë©”íƒ€ ë˜ëŠ” ì…ë ¥ê°’ì„ ì§€ì •í•˜ì„¸ìš”.'); showToast('í™œë™ í´ë”ëª…ì„ ì…ë ¥í•˜ê±°ë‚˜ ë©”íƒ€ë¥¼ ì„¤ì •í•˜ì„¸ìš”.'); return; }
            const payload={ studentId:studentId, subject:SUBJECT, activity:activity, section:section, files:[{ filename:zipFilename, contentBase64:b64, mime:'application/zip' }] };
            setProgress(60,'ì—…ë¡œë“œ ì¤‘...'); const res=await fetch(ENDPOINT,{ method:'POST', headers:{ 'Content-Type':'application/json', 'X-Submission-Key':SUBMIT_KEY }, body:JSON.stringify(payload) });
            const text=await res.text(); let data={}; try{ data=JSON.parse(text); }catch(_){ data={ raw:text }; }
            if (!res.ok){ const errorMsg=data.error||data.detail||data.message||res.statusText||`HTTP ${res.status}`; throw new Error(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${errorMsg}`); }
            const uploadedFile=data.files?.[0]; const filePath=uploadedFile?.name||zipFilename; const fullPath=`/ê³¼ì œì œì¶œ/${SUBJECT}/${activity}/${section}/${studentId}/${filePath}`;
            setStatus(`âœ… ì œì¶œ ì™„ë£Œ! ì €ì¥ ê²½ë¡œ: ${fullPath} â€” ë‹¤ìš´ë¡œë“œ í™•ì¸ ì¤‘â€¦`); setProgress(85,'ë‹¤ìš´ë¡œë“œ ì¤€ë¹„...');
            attemptLocalDownloadAndVerify(zipFilename); setProgress(100,'ì™„ë£Œ'); setTimeout(()=>showProgress(false),1500);
        }catch(err){ const errorMessage=err?.message||err||'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'; setStatus(`âŒ ì œì¶œ ì‹¤íŒ¨: ${errorMessage}`); showToast(`ì œì¶œ ì‹¤íŒ¨: ${errorMessage}`); setProgress(0,''); showProgress(false); } }

        async function retryLastUpload(){
            try{
                if(!lastZipBlob||!lastMeta){ showToast('ì¬ì‹œë„í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
                setStatus('ì €ì¥ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”');
                showProgress(true);
                setProgress(45,'ì—…ë¡œë“œ ì¤€ë¹„...');
                const b64=await blobToBase64(lastZipBlob);
                const sizeBytes=bytesFromBase64(b64);
                if(sizeBytes>8*1024*1024){ setStatus('ì—…ë¡œë“œ ì‹¤íŒ¨: ZIP ìš©ëŸ‰ ì´ˆê³¼ (8MB)'); showToast('ZIP íŒŒì¼ ìš©ëŸ‰ì´ 8MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.'); return; }
                const activity=(ACTIVITY_INPUT_DEFAULT||'').trim();
                if(!activity){ setStatus('í™œë™ í´ë”ëª…ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ë©”íƒ€ ë˜ëŠ” ì…ë ¥ê°’ì„ ì§€ì •í•˜ì„¸ìš”.'); showToast('í™œë™ í´ë”ëª…ì„ ì…ë ¥í•˜ê±°ë‚˜ ë©”íƒ€ë¥¼ ì„¤ì •í•˜ì„¸ìš”.'); return; }
                const payload={ studentId:lastMeta.studentId, subject:SUBJECT, activity:activity, section:lastMeta.section, files:[{ filename:lastMeta.zipFilename, contentBase64:b64, mime:'application/zip' }] };
                setProgress(60,'ì—…ë¡œë“œ ì¤‘...');
                const res=await fetch(ENDPOINT,{ method:'POST', headers:{ 'Content-Type':'application/json', 'X-Submission-Key':SUBMIT_KEY }, body:JSON.stringify(payload) });
                const text=await res.text();
                let data={};
                try{ data=JSON.parse(text); }catch(_){ data={ raw:text }; }
                if(!res.ok){ const reason=data.error||data.detail||data.message||res.statusText||'ì—…ë¡œë“œ ì‹¤íŒ¨'; setStatus(`ì œì¶œ ì‹¤íŒ¨: ${reason}`); showToast(`ì œì¶œ ì‹¤íŒ¨: ${reason}`); return; }
                const uploadedFile=data.files?.[0];
                const filePath=uploadedFile?.name||lastMeta.zipFilename;
                const fullPath=`/ê³¼ì œì œì¶œ/${SUBJECT}/${activity}/${lastMeta.section}/${lastMeta.studentId}/${filePath}`;
                setStatus(`âœ… ì œì¶œ ì™„ë£Œ! ì €ì¥ ê²½ë¡œ: ${fullPath} â€” ë‹¤ìš´ë¡œë“œ í™•ì¸ ì¤‘â€¦`);
                setProgress(85,'ë‹¤ìš´ë¡œë“œ ì¤€ë¹„...');
                attemptLocalDownloadAndVerify(lastMeta.zipFilename);
                setProgress(100,'ì™„ë£Œ');
                setTimeout(()=>showProgress(false),1500);
            }catch(err){
                const errorMessage=err?.message||err||'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
                setStatus(`âŒ ì œì¶œ ì‹¤íŒ¨: ${errorMessage}`);
                showToast(`ì œì¶œ ì‹¤íŒ¨: ${errorMessage}`);
            }
        }
    });
    </script>
</body>
</html>

