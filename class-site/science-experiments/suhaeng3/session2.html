<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>첫걸음, 마지막 걸음 프로젝트 - 2차시</title>
    <meta name="submission-subject" content="과학탐구실험2">
    <meta name="submission-activity" content="수행3_2차시">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Nanum+Myeongjo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR','Inter',sans-serif; background-color:#f3f4f6; }
        .tab-button-group { display:flex; flex-wrap:wrap; gap:0.5rem; background-color:#e5e7eb; padding:0.5rem; border-radius:0.75rem; }
    .tab-button { flex-grow:1; text-align:center; padding:0.75rem 0.5rem; border-radius:0.625rem; font-weight:600; color:#374151; cursor:pointer; transition:all .2s ease; border:1px solid #d1d5db; background-color:#ffffff; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .tab-button:hover { background-color:#f9fafb; color:#111827; border-color:#c7d2fe; }
    .tab-button.active { background-color:#ffffff; color:#4f46e5; border-color:#4f46e5; box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06); }
        .tab-content { display:none; }
        .tab-content.active { display:block; }
        .report-page { background-color:#fff; padding:2.5cm 2cm; box-shadow:0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); color:#1f2937; }
        .report-main-title { font-family:'Noto Sans KR',sans-serif; font-size:1.875rem; font-weight:700; text-align:center; margin-bottom:1rem; border-bottom:2px solid #111827; padding-bottom:1rem; }
        .report-section-title { font-family:'Noto Sans KR',sans-serif; font-size:1.5rem; font-weight:700; color:#111827; margin-top:2.5rem; margin-bottom:1rem; padding-bottom:0.5rem; border-bottom:1px solid #d1d5db; }
    .preview-text { white-space:pre-wrap; word-break:break-word; min-height:2.5em; line-height:1.8; color:#374151; font-family:'Nanum Myeongjo',serif; }
    .preview-text a { color:#2563eb; text-decoration:underline; }
        .preview-placeholder { color:#9ca3af; font-style:italic; }
        .tip-card { background: linear-gradient(135deg,#f5f3ff,#eef2ff); border-left:4px solid #6366f1; padding:1rem; border-radius:0.5rem; }
        .accordion-header button.open { background-color:#eef2ff; color:#4338ca; }
        .accordion-content { transition:max-height .3s ease-out, padding .3s ease-out; max-height:0; overflow:hidden; }
        .accordion-content.open { max-height:1500px; }

        /* Responsive typography & controls */
        html { font-size:16px; }
        @media (min-width: 640px) { html { font-size:16.5px; } }
        @media (min-width: 768px) { html { font-size:17px; } }
        @media (min-width: 1024px) { html { font-size:17.5px; } }
        @media (min-width: 1280px) { html { font-size:18px; } }

        .tab-button { font-size:.95rem; padding:.85rem .5rem; }
        @media (min-width: 640px) { .tab-button { font-size:1rem; } }
        @media (min-width: 1024px) { .tab-button { font-size:1.05rem; } }

        #download_zip_btn,
        #print_btn,
        #preview_newtab_btn,
        #retry_upload_btn,
        #add_source_btn,
        #clear_inputs_btn {
            font-size:.95rem; padding:.6rem 1rem;
        }
        @media (min-width: 640px) {
            #download_zip_btn,
            #print_btn,
            #preview_newtab_btn,
            #retry_upload_btn,
            #add_source_btn,
            #clear_inputs_btn { font-size:1rem; padding:.7rem 1.1rem; }
        }
        @media (min-width: 1024px) {
            #download_zip_btn,
            #print_btn,
            #preview_newtab_btn,
            #retry_upload_btn,
            #add_source_btn,
            #clear_inputs_btn { font-size:1.0625rem; padding:.8rem 1.2rem; }
        }

        label { font-size:.95rem; }
        textarea, input[type="text"], input[type="number"], select { font-size:1rem; }
        @media (min-width: 1024px) {
            textarea, input[type="text"], input[type="number"], select { font-size:1.0625rem; }
        }
        @page { size:A4 portrait; margin:2cm; }
        @media print { body *{ visibility:hidden } .printable-area, .printable-area *{ visibility:visible } .printable-area{ position:absolute; left:0; top:0; width:100%; padding:0; margin:0; box-shadow:none; border:none } .no-print{ display:none } }
    </style>
    <link rel="icon" href="data:,">
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-5xl mx-auto">
        <header class="text-center bg-white p-8 rounded-xl shadow-lg mb-6 no-print">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">첫걸음, 마지막 걸음 프로젝트 - 2차시</h1>
            <p class="text-lg text-gray-600 mt-2">3가지 지렛대 아이디어 + 기대효과 (부분 제출)</p>
            <div class="mt-4">
                <a href="./index.html" class="text-indigo-600 hover:underline">← 활동 허브로 돌아가기</a>
            </div>
        </header>

        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-md mb-6 no-print">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-6">
                <div class="flex items-center space-x-2 flex-wrap justify-center">
                    <input type="number" id="student_grade" min="1" max="3" step="1" inputmode="numeric" class="w-20 p-2 border border-gray-300 rounded-md text-center" placeholder="학년">
                    <label for="student_grade" class="font-semibold">학년</label>
                    <input type="number" id="student_class" min="1" max="20" step="1" inputmode="numeric" class="w-20 p-2 border border-gray-300 rounded-md text-center" placeholder="반">
                    <label for="student_class" class="font-semibold">반</label>
                    <input type="number" id="student_number" min="1" max="40" step="1" inputmode="numeric" class="w-20 p-2 border border-gray-300 rounded-md text-center" placeholder="번호">
                    <label for="student_number" class="font-semibold">번</label>
                    <input type="text" id="student_name" class="w-32 p-2 border border-gray-300 rounded-md" placeholder="이름">
                </div>
            </div>
        </div>

        <div class="mb-8 no-print">
            <div class="tab-button-group" aria-label="탭 메뉴">
                <button class="tab-button active" data-tab="guide2">활동 안내</button>
                <button class="tab-button" data-tab="tab4">활동지 작성</button>
                <button class="tab-button" data-tab="tab5">미리보기 및 제출</button>
            </div>
        </div>
            <div id="guide2" class="tab-content active">
                <div class="bg-white p-6 sm:p-8 rounded-lg shadow-md space-y-8">
                    <section>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">2차시 목표</h2>
                        <div class="tip-card text-gray-700">
                            <ul class="list-disc list-inside text-sm space-y-1">
                                <li>3가지 지렛대(공간·혜택·협력) 관점으로 아이디어 구체화</li>
                                <li>기대효과를 구체적 장면으로 서술</li>
                            </ul>
                        </div>
                    </section>
                    <section>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">3가지 지렛대 예시</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="p-4 bg-gray-50 rounded-lg border"><h3 class="font-bold">공간</h3><p class="text-sm text-gray-600 mt-1">비가림, 조명, CCTV, 충전 등</p></div>
                            <div class="p-4 bg-gray-50 rounded-lg border"><h3 class="font-bold">혜택</h3><p class="text-sm text-gray-600 mt-1">환승 포인트, 주차 할인, 앱 연동</p></div>
                            <div class="p-4 bg-gray-50 rounded-lg border"><h3 class="font-bold">협력</h3><p class="text-sm text-gray-600 mt-1">지자체-기업-지역상권 협력</p></div>
                        </div>
                    </section>
                    <!-- Guide items 3~4 from hub -->
                    <section>
                        <div class="accordion-item border-t pt-4">
                            <div class="accordion-header"><button class="w-full text-left p-4 rounded-lg font-semibold text-lg text-gray-800 hover:bg-gray-100 flex justify-between items-center"><span>💡 3. '3가지 지렛대' 아이디어 내기</span><svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button></div>
                            <div class="accordion-content"><div class="p-4 text-gray-600 space-y-4">
                                <p>하나의 좋은 아이디어는 여러 요소가 균형을 이룰 때 나옵니다. 우리는 문제를 세 가지 관점, '지렛대'로 나누어 생각해 볼 거예요.</p>
                                <ul class="list-disc list-inside space-y-2 bg-gray-50 p-4 rounded-md border">
                                    <li><strong>🏛️ 공간 (물리적 인프라):</strong> 허브를 안전하고 편리하게 만드는 '하드웨어'입니다. 디자인, 시설, 안전장치 등이 여기에 해당해요.</li>
                                    <li><strong>💡 혜택 (디지털/정책):</strong> 사람들이 허브를 쓰고 싶게 만드는 '동기 부여'입니다. 요금 할인, 포인트, 앱 연동 같은 '소프트웨어' 전략이 필요해요.</li>
                                    <li><strong>🤝 협력 (운영 모델):</strong> 이 좋은 아이디어를 지속 가능하게 만드는 '시스템'입니다. 누가 운영하고, 비용은 어떻게 마련하며, 누구와 협력할지 고민해야 합니다.</li>
                                </ul>
                                <p class="font-semibold text-gray-800">이 세 가지를 모두 고려해야 현실적이고 성공적인 제안을 할 수 있습니다.</p>
                            </div></div>
                        </div>
                        <div class="accordion-item border-t pt-4">
                            <div class="accordion-header"><button class="w-full text-left p-4 rounded-lg font-semibold text-lg text-gray-800 hover:bg-gray-100 flex justify-between items-center"><span>📈 4. 기대 효과, 어떻게 쓸까?</span><svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button></div>
                            <div class="accordion-content"><div class="p-4 text-gray-600 space-y-3">
                                <p>제안한 아이디어가 실행되었을 때, '누구에게', '어떤' 긍정적인 변화가 생길지 구체적인 장면을 상상해서 그리는 단계입니다.</p>
                                <div class="tip-card p-4 rounded-lg">
                                    <h4 class="font-bold text-indigo-800">생각을 넓히는 질문</h4>
                                    <ul class="list-disc list-inside mt-2 text-sm">
                                        <li>여러분의 아이디어가 실현되면 누가 가장 좋아할까요?</li>
                                        <li>도시의 모습은 어떻게 바뀔까요? (예: 깨끗해진다, 활기차진다 등)</li>
                                        <li>사람들의 생활은 어떻게 더 편리해질까요?</li>
                                    </ul>
                                    <div class="mt-4 p-3 rounded-lg bg-indigo-50 border border-indigo-200">
                                        <h5 class="font-bold text-indigo-800 text-sm">✍️ 작성 예시</h5>
                                        <p class="text-sm text-indigo-900 mt-1">
                                            "스마트 모빌리티 허브가 설치되면, <strong>(누구에게)</strong> S-BRT로 통학하는 학생들은 <strong>(어떤 변화)</strong> 정류장까지 킥보드를 타고 와 안전하게 주차하고 버스로 편리하게 환승할 수 있게 될 것이다. 또한, 보행자들은 아무렇게나 방치된 킥보드가 사라져 쾌적하고 안전한 인도를 걸을 수 있게 된다."
                                        </p>
                                    </div>
                                </div>
                            </div></div>
                        </div>
                    </section>
                </div>
            </div>

        <main>
            <div id="tab4" class="tab-content active">
                <div class="bg-white p-6 sm:p-10 rounded-lg shadow-md space-y-8">
                    <header class="text-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">2차시 활동지</h2>
                        <p class="text-gray-600">3가지 지렛대 아이디어와 기대효과를 작성하세요.</p>
                    </header>
                    <div class="flex justify-end -mt-2">
                        <button id="clear_inputs_btn" class="bg-red-50 text-red-700 font-semibold py-2 px-4 rounded-lg border border-red-200 hover:bg-red-100 transition text-sm">🗑️ 입력 내용 삭제</button>
                    </div>
                    <section>
                        <h3 class="text-xl font-bold text-indigo-700 mb-4">1. 스마트 모빌리티 허브 아이디어 (3가지 지렛대)</h3>
                        <div class="text-sm bg-blue-50 border border-blue-200 text-blue-900 rounded-md p-3 mb-2">
                            <div class="font-semibold mb-1">평가 기준</div>
                            <ul class="list-disc list-inside space-y-0.5">
                                <li>제시된 3가지 영역(공간·혜택·협력)에서 각 아이디어를 제시</li>
                                <li>각 아이디어에 대해 <strong>구체적인 근거</strong>를 들어 <strong>실행 가능</strong>한 수준으로 서술</li>
                            </ul>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <label for="field_idea_infra" class="font-semibold text-gray-700 block mb-2">🏛️ 물리적 인프라 (공간)</label>
                                <textarea id="field_idea_infra" rows="5" class="w-full p-3 border border-gray-300 rounded-md" placeholder="예시: 밤에도 안전하게 이용할 수 있도록 허브에 CCTV와 밝은 LED 조명을 설치합니다. 이는 창원시에서 범죄 예방 디자인 예산을 활용해 설치할 수 있습니다."></textarea>
                            </div>
                            <div>
                                <label for="field_idea_policy" class="font-semibold text-gray-700 block mb-2">💡 디지털/정책 (혜택)</label>
                                <textarea id="field_idea_policy" rows="5" class="w-full p-3 border border-gray-300 rounded-md" placeholder="예시: 허브에 PM을 주차하고 S-BRT로 환승하면, 다음 PM 이용 시 쓸 수 있는 100원 할인 쿠폰을 지급합니다. 이는 PM 운영사와 창원시가 협력하여 앱 시스템을 개발해 구현할 수 있습니다."></textarea>
                            </div>
                            <div>
                                <label for="field_idea_operation" class="font-semibold text-gray-700 block mb-2">🤝 운영 모델 (협력)</label>
                                <textarea id="field_idea_operation" rows="5" class="w-full p-3 border border-gray-300 rounded-md" placeholder="예시: 허브 운영 및 관리 비용을 창원시와 PM 운영사가 5:5로 분담합니다. 주변 상점은 허브 이용자에게 할인 쿠폰을 제공하는 방식으로 참여할 수 있습니다."></textarea>
                            </div>
                        </div>
                    </section>
                    <section>
                        <h3 class="text-xl font-bold text-indigo-700 mb-4">2. 기대 효과</h3>
                        <div>
                            <div class="text-sm bg-blue-50 border border-blue-200 text-blue-900 rounded-md p-3 mb-2">
                                <div class="font-semibold mb-1">평가 기준</div>
                                <ul class="list-disc list-inside space-y-0.5">
                                    <li>해결방안과 기대효과를 <strong>직접적으로 연결</strong>하여 근거를 들어 서술</li>
                                    <li>기대효과로 인한 <strong>혜택의 대상</strong>을 명시</li>
                                </ul>
                            </div>
                            <label for="field_effects" class="font-semibold text-gray-700 block mb-2">아이디어 실현 시 기대되는 변화</label>
                            <textarea id="field_effects" rows="6" class="w-full p-3 border border-gray-300 rounded-md" placeholder="예시: 학생들은 S-BRT 정류장까지 킥보드로 편리하게 이동 후, 안전하게 주차하고 버스로 환승할 수 있게 됩니다. 또한, 보행자들은 인도에 방치된 킥보드가 사라져 안전하고 쾌적하게 걸을 수 있습니다."></textarea>
                        </div>
                    </section>
                    <section>
                        <h3 class="text-xl font-bold text-indigo-700 mb-4">3. 정보 출처</h3>
                        <div>
                            <div class="text-sm text-gray-600 mb-2">아이디어와 기대효과에 참고한 근거 자료가 있다면 출처를 기재하세요. (선택사항)</div>
                            <div id="sources_container" class="space-y-4"></div>
                            <button id="add_source_btn" class="mt-2 bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition text-sm">+ 출처 추가</button>
                        </div>
                    </section>
                </div>
            </div>

            <div id="tab5" class="tab-content">
                <div class="bg-white p-6 sm:p-8 rounded-lg shadow-md mb-6 no-print">
                    <div class="flex justify-center items-center gap-4 flex-wrap">
                        <button id="download_zip_btn" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition text-base">📦 ZIP으로 다운로드</button>
                        <button id="print_btn" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition text-base">🖨️ PDF로 저장</button>
                        <button id="preview_newtab_btn" class="bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition text-base">👁️ 미리보기(새 탭)</button>
                        <button id="retry_upload_btn" class="hidden bg-yellow-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-yellow-600 transition text-base">🔄 업로드 재시도</button>
                    </div>
                    <p class="text-center text-sm text-gray-600 mt-4" aria-live="polite" role="status"><span id="submit_status"></span></p>
                    <div id="progress_container" class="w-full max-w-xl mx-auto mt-3 hidden" aria-hidden="true">
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div id="progress_bar" class="bg-indigo-600 h-3 rounded-full" style="width:0%"></div>
                        </div>
                        <p id="progress_text" class="text-center text-xs text-gray-600 mt-1"></p>
                    </div>
                </div>
                <div class="bg-gray-200 p-4 sm:p-8 rounded-lg">
                    <div class="printable-area report-page" id="report-content">
                        <h1 id="preview_main_title" class="report-main-title">스마트 모빌리티 허브 아이디어 제안서 (2차시)</h1>
                        <p class="text-right text-gray-600 mb-10" style="font-family: 'Noto Sans KR', sans-serif;">
                            <span id="preview_student_grade">1</span>학년 <span id="preview_student_class">0</span>반 <span id="preview_student_number">00</span>번 이름: <span id="preview_student_name">ㅇㅇㅇ</span>
                        </p>
                        <h2 class="report-section-title">III. 스마트 모빌리티 허브 아이디어</h2>
                        <h3 class="font-semibold mt-4 mb-2" style="font-family: 'Noto Sans KR', sans-serif;">가. 물리적 인프라 (공간)</h3>
                        <p class="preview-text" id="preview_idea_infra"><span class="preview-placeholder">내용을 입력하세요...</span></p>
                        <h3 class="font-semibold mt-4 mb-2" style="font-family: 'Noto Sans KR', sans-serif;">나. 디지털/정책 (혜택)</h3>
                        <p class="preview-text" id="preview_idea_policy"><span class="preview-placeholder">내용을 입력하세요...</span></p>
                        <h3 class="font-semibold mt-4 mb-2" style="font-family: 'Noto Sans KR', sans-serif;">다. 운영 모델 (협력)</h3>
                        <p class="preview-text" id="preview_idea_operation"><span class="preview-placeholder">내용을 입력하세요...</span></p>
                        <h2 class="report-section-title">IV. 기대 효과</h2>
                        <p class="preview-text" id="preview_effects"><span class="preview-placeholder">내용을 입력하세요...</span></p>
                        <h2 class="report-section-title">V. 정보 출처</h2>
                        <div class="preview-text" id="preview_sources"><span class="preview-placeholder">내용을 입력하세요...</span></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast-notification" class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 no-print">저장되었습니다!</div>

    <!-- iOS Save Help Modal -->
    <div id="ios-help-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50 no-print" role="dialog" aria-modal="true" aria-labelledby="ios-help-title">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h3 id="ios-help-title" class="text-lg font-bold text-gray-800">iOS에서 ZIP 파일 저장하기</h3>
            <ol class="text-gray-700 mt-3 list-decimal list-inside space-y-2">
                <li>아래 "파일에 저장(공유 시트)" 버튼을 눌러 공유 시트를 여세요.</li>
                <li>공유 시트에서 "파일에 저장"을 선택하세요.</li>
                <li>원하는 저장 위치(예: iCloud Drive 또는 내 iPhone)와 폴더를 선택하고 저장하세요.</li>
            </ol>
            <p class="text-gray-500 text-sm mt-3">팁: 저장 후 "파일" 앱에서 방금 저장한 위치로 이동해 확인할 수 있어요.</p>
            <div class="mt-6 flex flex-col sm:flex-row justify-end gap-3">
                <button id="ios-help-download-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">대신 바로 다운로드</button>
                <div class="flex-1"></div>
                <button id="ios-help-close-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">닫기</button>
                <button id="ios-help-confirm-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">파일에 저장(공유 시트)</button>
            </div>
        </div>
    </div>

    <!-- Mobile Download Center Modal -->
    <div id="inapp-download-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50 no-print" role="dialog" aria-modal="true" aria-labelledby="inapp-title">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h3 id="inapp-title" class="text-lg font-bold text-gray-800">모바일 브라우저에서 저장하기</h3>
            <p class="text-gray-600 mt-2">현재 사용 중인 브라우저에서는 파일 저장이 제한될 수 있어요. 아래 버튼으로 서버에서 직접 내려받아 주세요.</p>
            <div class="mt-4 grid grid-cols-1 gap-3">
                <button id="inapp-server-download-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">서버에서 다운로드(권장)</button>
                <button id="inapp-retry-btn" class="hidden px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">재시도</button>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="inapp-close-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">닫기</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const dom = {
            tabs: document.querySelectorAll('.tab-button'),
            tabContents: document.querySelectorAll('.tab-content'),
            accordions: document.querySelectorAll('.accordion-header button'),
            downloadZipBtn: document.getElementById('download_zip_btn'),
            printBtn: document.getElementById('print_btn'),
            previewNewTabBtn: document.getElementById('preview_newtab_btn'),
            retryUploadBtn: document.getElementById('retry_upload_btn'),
            toast: document.getElementById('toast-notification'),
            allInputs: document.querySelectorAll('#tab4 input, #tab4 textarea, input#student_grade, input#student_class, input#student_number, input#student_name'),
            addSourceBtn: document.getElementById('add_source_btn'),
            sourcesContainer: document.getElementById('sources_container'),
            clearBtn: document.getElementById('clear_inputs_btn'),
            submitStatus: document.getElementById('submit_status'),
            // iOS Help Modal
            iosHelpModal: document.getElementById('ios-help-modal'),
            iosHelpConfirmBtn: document.getElementById('ios-help-confirm-btn'),
            iosHelpCloseBtn: document.getElementById('ios-help-close-btn'),
            iosHelpDownloadBtn: document.getElementById('ios-help-download-btn'),
            // In-App Download Center
            inappModal: document.getElementById('inapp-download-modal'),
            inappCloseBtn: document.getElementById('inapp-close-btn'),
            inappServerDownloadBtn: document.getElementById('inapp-server-download-btn'),
            inappRetryBtn: document.getElementById('inapp-retry-btn'),
        };

        const fields = {
            'student_grade': 'preview_student_grade',
            'student_class': 'preview_student_class', 'student_number': 'preview_student_number', 'student_name': 'preview_student_name',
            'field_idea_infra': 'preview_idea_infra', 'field_idea_policy': 'preview_idea_policy',
            'field_idea_operation': 'preview_idea_operation',
            'field_effects': 'preview_effects'
        };

        const storageKey = 'firstLastMileProjectData_session2';

        dom.tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));
        if (dom.accordions) dom.accordions.forEach(button => button.addEventListener('click', toggleAccordion));
        dom.allInputs.forEach(input => input.addEventListener('input', updatePreviewAndSave));
        if (dom.addSourceBtn) dom.addSourceBtn.addEventListener('click', () => addSourceElement());
        if (dom.sourcesContainer) {
            dom.sourcesContainer.addEventListener('click', (e) => { if (e.target.classList.contains('delete_source_btn')) { e.target.closest('.source-entry').remove(); updatePreviewAndSave(); } });
            dom.sourcesContainer.addEventListener('change', (e) => { if (e.target.classList.contains('source-type-select')) { updateSourceInputs(e.target); updatePreviewAndSave(); } });
            dom.sourcesContainer.addEventListener('input', updatePreviewAndSave);
        }

        if (dom.downloadZipBtn) dom.downloadZipBtn.addEventListener('click', handleZipDownloadAndSubmit);
        if (dom.printBtn) dom.printBtn.addEventListener('click', printReport);
        if (dom.previewNewTabBtn) dom.previewNewTabBtn.addEventListener('click', openPreviewInNewTab);
        if (dom.retryUploadBtn) dom.retryUploadBtn.addEventListener('click', retryLastUpload);
        if (dom.clearBtn) dom.clearBtn.addEventListener('click', handleClearAll);

        // iOS Help Modal 이벤트 리스너
        if (dom.iosHelpConfirmBtn) dom.iosHelpConfirmBtn.addEventListener('click', () => {
            hideModal(dom.iosHelpModal);
            if (lastZipBlob && lastMeta?.zipFilename) {
                shareToFilesApp(lastZipBlob, lastMeta.zipFilename);
            }
        });
        if (dom.iosHelpCloseBtn) dom.iosHelpCloseBtn.addEventListener('click', () => hideModal(dom.iosHelpModal));
        if (dom.iosHelpDownloadBtn) dom.iosHelpDownloadBtn.addEventListener('click', () => {
            hideModal(dom.iosHelpModal);
            if (lastZipBlob && lastMeta?.zipFilename) {
                triggerBlobDownload(lastZipBlob, lastMeta.zipFilename);
            }
        });

        // In-App Download Center 이벤트 리스너
        if (dom.inappCloseBtn) dom.inappCloseBtn.addEventListener('click', () => hideModal(dom.inappModal));
        if (dom.inappServerDownloadBtn) dom.inappServerDownloadBtn.addEventListener('click', () => {
            hideModal(dom.inappModal);
            serverDownloadLastZip();
        });
        if (dom.inappRetryBtn) dom.inappRetryBtn.addEventListener('click', () => {
            hideModal(dom.inappModal);
            if (lastZipBlob && lastMeta?.zipFilename) {
                attemptLocalDownloadAndVerify(lastMeta.zipFilename);
            }
        });

        loadFromBrowser();
        // 초기 로드 시 메타의 활동값을 입력란에 반영(저장된 값이 없을 때)
        const actElInit=document.getElementById('submission_activity');
        if (actElInit && (!actElInit.value || actElInit.value.trim()==='')) actElInit.value=ACTIVITY_INPUT_DEFAULT;
        switchTab('guide2');
        updatePreview();

        // Hide PDF print button only on iOS and in-app browsers (Android에서는 노출)
        const __env = detectInApp();
        if ((isIOS() || __env.isInApp) && dom.printBtn) {
            dom.printBtn.classList.add('hidden');
        }

        // --- Modal focus trap helpers ---
        let __lastTriggerEl = null;
        function getFocusable(el) {
            return el.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        }
        function showModal(el, triggerEl = null) {
            __lastTriggerEl = triggerEl || document.activeElement;
            el.classList.remove('hidden');
            el.setAttribute('aria-hidden', 'false');
            const focusable = getFocusable(el);
            if (focusable.length > 0) {
                focusable[0].focus();
            }
            // ESC 키로 닫기
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    hideModal(el);
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }
        function hideModal(el) {
            el.classList.add('hidden');
            el.setAttribute('aria-hidden', 'true');
            if (__lastTriggerEl) {
                __lastTriggerEl.focus();
                __lastTriggerEl = null;
            }
        }

        // 아코디언 메뉴를 기본적으로 모두 펼칩니다.
        if (dom.accordions) dom.accordions.forEach(button => setAccordionState(button, true));

        function switchTab(targetTabId) { dom.tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === targetTabId)); dom.tabContents.forEach(content => content.classList.toggle('active', content.id === targetTabId)); window.scrollTo(0,0); }
        
        function setAccordionState(button, open = true) {
            const content = button.parentElement.nextElementSibling;
            const icon = button.querySelector('svg');
            button.classList.toggle('open', open);
            content.classList.toggle('open', open);
            if (open) {
                // 콘텐츠가 완전히 표시된 후 정확한 높이를 계산하기 위해 약간의 지연을 줍니다.
                setTimeout(() => {
                    content.style.maxHeight = content.scrollHeight + 'px';
                    content.style.paddingTop = '1rem';
                    content.style.paddingBottom = '1rem';
                }, 10);
                if(icon) icon.style.transform = 'rotate(180deg)';
            } else {
                content.style.maxHeight = '0';
                content.style.paddingTop = '0';
                content.style.paddingBottom = '0';
                if(icon) icon.style.transform = 'rotate(0deg)';
            }
        }
        function toggleAccordion(event) { 
            const button = event.currentTarget;
            const isOpen = !button.classList.contains('open');
            setAccordionState(button, isOpen);
        }

        function updatePreviewAndSave() { updatePreview(); saveToBrowser(); }
        function updatePreview() { Object.entries(fields).forEach(([fieldId, previewId]) => { const inputEl = document.getElementById(fieldId); const previewEl = document.getElementById(previewId); if (!inputEl || !previewEl) return; const value = inputEl.value.trim(); const placeholderSpan = previewEl.querySelector('.preview-placeholder'); const placeholderText = placeholderSpan ? placeholderSpan.textContent : `[${fieldId}]`; if (value) { previewEl.textContent = value; } else { previewEl.innerHTML = `<span class="preview-placeholder">${placeholderText}</span>`; } }); updateSourcesPreview(); }
        function getFormData() { const data = {}; dom.allInputs.forEach(input => data[input.id] = input.value); data.sources = Array.from(document.querySelectorAll('.source-entry')).map(entry => ({ type: entry.dataset.type, values: Array.from(entry.querySelectorAll('input')).map(input => input.value) })); return data; }
        function saveToBrowser() { localStorage.setItem(storageKey, JSON.stringify(getFormData())); showToast('자동 저장되었습니다.'); }
        function loadFromBrowser() { const saved = localStorage.getItem(storageKey); if (!saved) return; const data = JSON.parse(saved); Object.entries(data).forEach(([k,v]) => { if (k === 'sources' && Array.isArray(v)) { v.forEach(s => addSourceElement(s)); } else { const el = document.getElementById(k); if (el) el.value = v; } }); updatePreview(); }
        function updateSourcesPreview() {
            const sourcesPreview = document.getElementById('preview_sources');
            const entries = document.querySelectorAll('.source-entry');
            if (!sourcesPreview) return;
            if (entries.length === 0) {
                sourcesPreview.innerHTML = `<span class="preview-placeholder">내용을 입력하세요...</span>`;
                return;
            }
            let items = [];
            entries.forEach(entry => {
                const typeRaw = entry.dataset.type || '';
                const type = (typeRaw === '인터넷 URL') ? '인터넷 기사/게시물' : typeRaw; // 호환
                const rawInputs = Array.from(entry.querySelectorAll('input')).map(i => i.value.trim());
                const values = rawInputs.map(v => escapeHtml(v));
                let parts = [];
                switch(type){
                    case '논문':
                        if(values[0]) parts.push(values[0]);
                        if(values[1]) parts.push(`(${values[1]})`);
                        if(values[2]) parts.push(`${values[2]}.`);
                        if(values[3]) parts.push(values[3]);
                        break;
                    case '도서':
                        if(values[0]) parts.push(values[0]);
                        if(values[3]) parts.push(`(${values[3]})`);
                        const bookTitle=values[1]; if(bookTitle) parts.push(`${bookTitle}.`);
                        if(values[2]) parts.push(values[2]);
                        break;
                    case '학술잡지':
                        if(values[2]) parts.push(values[2]);
                        if(values[3]) parts.push(`(${values[3]})`);
                        if(values[1]) parts.push(`${values[1]}.`);
                        if(values[0]) parts.push(values[0]);
                        break;
                    case '인터넷 기사/게시물':
                    case '인터넷 URL':
                        if(values[2]) parts.push(values[2]);
                        if(values[0]) parts.push(values[0]);
                        if(values[1]) parts.push(`'${values[1]}'.`);
                        if (rawInputs[3]){
                            const safeUrl = escapeHtml(rawInputs[3]);
                            parts.push(`URL: <a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${safeUrl}</a>`);
                        }
                        break;
                }
                let li = parts.join(' ').replace(/\s\./g,'.').replace(/\s,/g,',');
                items.push(`<li>${li}</li>`);
            });
            sourcesPreview.innerHTML = `<ol class="list-decimal list-inside" style="line-height: 1.8;">${items.join('')}</ol>`;
        }
        function escapeHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;'); }
        function addSourceElement(sourceData = null) {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'source-entry border p-4 rounded-md bg-gray-50 space-y-3';
            const typeRaw = sourceData?.type || '논문';
            const type = (typeRaw === '인터넷 URL') ? '인터넷 기사/게시물' : typeRaw; // 호환
            entryDiv.dataset.type = type;
            entryDiv.innerHTML = `<div class="flex justify-between items-center"><select class="source-type-select p-2 border border-gray-300 rounded-md bg-white"><option ${type==='논문'?'selected':''}>논문</option><option ${type==='도서'?'selected':''}>도서</option><option ${type==='학술잡지'?'selected':''}>학술잡지</option><option ${type==='인터넷 기사/게시물'?'selected':''}>인터넷 기사/게시물</option></select><button class="delete_source_btn bg-red-500 text-white font-bold py-1 px-3 rounded-lg hover:bg-red-600 text-sm">삭제</button></div><div class="source-inputs grid grid-cols-1 sm:grid-cols-2 gap-2"></div>`;
            dom.sourcesContainer.appendChild(entryDiv);
            updateSourceInputs(entryDiv.querySelector('.source-type-select'), sourceData?.values);
        }
        function updateSourceInputs(selectElement, values = null) {
            const inputsContainer = selectElement.closest('.source-entry').querySelector('.source-inputs');
            let type = selectElement.value;
            if (type === '인터넷 URL') type = '인터넷 기사/게시물'; // 호환
            selectElement.closest('.source-entry').dataset.type = type;
            const fields = (type==='논문')
                ? ['저자*','연도*','논문 제목*','학술지명','권','호','페이지']
                : (type==='도서')
                ? ['저자*','도서명*','출판사*','연도']
                : (type==='학술잡지')
                ? ['잡지명*','기사 제목*','기자명*','발행일']
                : ['웹사이트명*','글 제목*','작성자(기자)*','URL*']; // 인터넷 기사/게시물
            let i=0;
            inputsContainer.innerHTML = fields.map(label=>{
                const required=label.endsWith('*');
                const name=label.replace('*','');
                const val=values?.[i++]||'';
                return `<label class="block"><span class="text-gray-700 text-sm">${name}${required?'<span class="text-red-500">*</span>':''}</span><input type="text" placeholder="${name}" value="${val}" class="w-full p-2 mt-1 border border-gray-300 rounded-md text-sm"></label>`;
            }).join('');
        }
        function showToast(message) { const toast = dom.toast; if (!toast) return; toast.textContent = message; toast.style.opacity = 1; setTimeout(()=>{ toast.style.opacity = 0; }, 1200); }
        function handleClearAll(){ try{ const ok=window.confirm('입력한 내용을 모두 삭제하시겠어요?\n이 작업은 되돌릴 수 없습니다.'); if(!ok) return; clearFormAndStorage(); showToast('입력 내용이 삭제되었습니다.'); }catch(_){} }
        function clearFormAndStorage(){ try{ localStorage.removeItem(storageKey); localStorage.removeItem(SUBMIT_META_KEY); }catch(_){} Array.from(dom.allInputs).forEach(el=>{ if(el.tagName==='INPUT' || el.tagName==='TEXTAREA'){ el.value=''; } }); if(dom.sourcesContainer){ dom.sourcesContainer.innerHTML=''; } if(dom.retryUploadBtn){ dom.retryUploadBtn.classList.add('hidden'); dom.retryUploadBtn.dataset.show=''; } if (typeof lastZipBlob!=='undefined') lastZipBlob=null; if (typeof lastMeta!=='undefined') lastMeta=null; setStatus(''); updatePreview(); }

        function getReportFilename(){ const grade=(document.getElementById('student_grade').value||'1').trim(); const studentClass=(document.getElementById('student_class').value||'0').trim().padStart(2,'0'); const studentNumber=(document.getElementById('student_number').value||'0').trim().padStart(2,'0'); const studentId=`${grade}${studentClass}${studentNumber}`; const studentName=document.getElementById('student_name').value.trim()||'이름없음'; return `${studentId}_${studentName}_스마트모빌리티_제안서_2차시`; }
        function printReport(){ const originalTitle=document.title; document.title=getReportFilename(); window.print(); setTimeout(()=>{ document.title=originalTitle; }, 500); }
        function openPreviewInNewTab(){ try{ const reportContent=document.getElementById('report-content').innerHTML; const now=new Date(); const ts=`${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}`; const title=`미리보기-2차시-${ts}`; const docHtml=generateDocHtml(title, reportContent); const blob=new Blob([docHtml],{type:'text/html'}); const url=URL.createObjectURL(blob); window.open(url,'_blank'); setTimeout(()=>URL.revokeObjectURL(url),10000);}catch(_){}}

        function setStatus(text){ if (dom.submitStatus) dom.submitStatus.textContent=text||''; }
        function showProgress(show){ const c=document.getElementById('progress_container'); if(!c) return; c.classList.toggle('hidden', !show); c.setAttribute('aria-hidden', show?'false':'true'); }
        function setProgress(percent,label=''){ const bar=document.getElementById('progress_bar'); const txt=document.getElementById('progress_text'); if(bar) bar.style.width=`${Math.max(0,Math.min(100,percent))}%`; if(txt) txt.textContent=label||''; }

        const ENDPOINT='/.netlify/functions/submit';
        const SUBMIT_KEY='S-2025-github2025subject';
        const SUBJECT=document.querySelector('meta[name="submission-subject"]')?.content||'과학탐구실험2';
        const ACTIVITY_INPUT_DEFAULT=document.querySelector('meta[name="submission-activity"]')?.content||'수행3_2차시';
        const SUBMIT_META_KEY='submit_meta_session2';

        ['student_grade','student_class','student_number','student_name'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('input', saveSubmitMeta); });
        loadSubmitMeta();
        function saveSubmitMeta(){ const meta={ grade:document.getElementById('student_grade')?.value||'', class:document.getElementById('student_class')?.value||'', number:document.getElementById('student_number')?.value||'', name:document.getElementById('student_name')?.value||'', activity:document.getElementById('submission_activity')?.value||ACTIVITY_INPUT_DEFAULT, }; try{ localStorage.setItem(SUBMIT_META_KEY, JSON.stringify(meta)); }catch(_){} }
        function loadSubmitMeta(){ try{ const raw=localStorage.getItem(SUBMIT_META_KEY); if(!raw) return; const meta=JSON.parse(raw); if(meta.grade!=null) document.getElementById('student_grade').value=meta.grade; if(meta.class!=null) document.getElementById('student_class').value=meta.class; if(meta.number!=null) document.getElementById('student_number').value=meta.number; if(meta.name!=null) document.getElementById('student_name').value=meta.name; const actEl=document.getElementById('submission_activity'); if(actEl) actEl.value=meta.activity||ACTIVITY_INPUT_DEFAULT; }catch(_){} }

        function generateDocHtml(dynamicTitle, reportInnerHtml){ return `<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${dynamicTitle}</title><script src="https://cdn.tailwindcss.com"><\/script><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Nanum+Myeongjo:wght@400;700&display=swap" rel="stylesheet"><style>body{font-family:'Noto Sans KR','Inter',sans-serif;background-color:#f3f4f6;margin:0}*{color:inherit !important}.report-page{background-color:#fff;padding:2.5cm 2cm;box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);color:#1f2937}.printable-area{width:100%}.report-main-title{font-family:'Noto Sans KR',sans-serif;font-size:1.875rem;font-weight:700;text-align:center;margin-bottom:1rem;border-bottom:2px solid #111827;padding-bottom:1rem}.report-section-title{font-family:'Noto Sans KR',sans-serif;font-size:1.5rem;font-weight:700;color:#111827;margin-top:2.5rem;margin-bottom:1rem;padding-bottom:.5rem;border-bottom:1px solid #d1d5db}.preview-text{white-space:pre-wrap;word-break:break-word;min-height:2.5em;line-height:1.8;color:#374151;font-family:'Nanum Myeongjo',serif}.preview-placeholder{color:#9ca3af !important;font-style:italic}@page{size:A4 portrait;margin:2cm}@media print{body *{visibility:hidden}.printable-area,.printable-area *{visibility:visible}.printable-area{position:absolute;left:0;top:0;width:100%;padding:0;margin:0;box-shadow:none;border:none}.no-print{display:none}}</style></head><body><div class="report-page"><div class="printable-area">${reportInnerHtml}</div></div></body></html>`; }

        function calcSectionCode(grade,klass){ const g=String(grade||'').trim(); const k=String(klass||'').trim().padStart(2,'0'); return `${g}${k}`; }
        function calcStudentId(grade,klass,number){ const g=String(grade||'').trim(); const k=String(klass||'').trim().padStart(2,'0'); const n=String(number||'').trim().padStart(2,'0'); return `${g}${k}${n}`; }

        function validateForm(){ const gradeEl=document.getElementById('student_grade'); const classEl=document.getElementById('student_class'); const numberEl=document.getElementById('student_number'); const nameEl=document.getElementById('student_name'); const grade=parseInt((gradeEl.value||'').trim(),10); const klass=parseInt((classEl.value||'').trim(),10); const number=parseInt((numberEl.value||'').trim(),10); const name=(nameEl.value||'').trim(); if(Number.isNaN(grade)||grade<1||grade>3){ showToast('학년은 1~3 사이의 숫자여야 합니다.'); gradeEl.focus(); return null; } if(Number.isNaN(klass)||klass<1||klass>20){ showToast('반은 1~20 사이의 숫자여야 합니다.'); classEl.focus(); return null; } if(Number.isNaN(number)||number<1||number>40){ showToast('번호는 1~40 사이의 숫자여야 합니다.'); numberEl.focus(); return null; } if(!name){ showToast('이름을 입력하세요.'); nameEl.focus(); return null; } return { grade, klass, number, name }; }

        async function blobToBase64(blob){ return await new Promise((resolve,reject)=>{ const reader=new FileReader(); reader.onload=()=>{ const result=reader.result||''; const commaIdx=String(result).indexOf(','); const b64=commaIdx>=0?String(result).slice(commaIdx+1):String(result); resolve(b64); }; reader.onerror=()=>reject(reader.error); reader.readAsDataURL(blob); }); }
        function bytesFromBase64(b64){ const len=b64.length; const pad=(b64.endsWith('==')?2:(b64.endsWith('=')?1:0)); return Math.floor((len*3)/4)-pad; }

        function triggerBlobDownload(blob, filename){ try{ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href); showToast('ZIP 파일이 다운로드되었습니다.'); return true; }catch(_){ return false; } }
        
        async function triggerBlobDownloadWithShare(blob, filename) {
            try {
                // iOS Safari에서 다운로드 후 공유 기능 활성화
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // 다운로드 후 잠시 대기 후 공유 시도
                setTimeout(async () => {
                    try {
                        // iOS에서 Web Share API로 파일 공유 시도
                        if (navigator.share && navigator.canShare) {
                            const file = new File([blob], filename, { type: 'application/zip' });
                            const shareData = {
                                files: [file],
                                title: filename,
                                text: '다운로드된 ZIP 파일을 파일 앱에 저장하세요'
                            };
                            
                            if (navigator.canShare(shareData)) {
                                await navigator.share(shareData);
                                setStatus('✅ 파일이 다운로드되고 공유되었습니다.');
                                showToast('다운로드 및 공유 완료');
                            }
                        }
                    } catch (shareError) {
                        console.log('공유 시도 실패:', shareError);
                        // 공유 실패해도 다운로드는 성공했으므로 정상 처리
                    }
                }, 1000);
                
                URL.revokeObjectURL(url);
                showToast('ZIP 파일이 다운로드되었습니다. 공유 옵션을 확인하세요.');
                return true;
            } catch (error) {
                console.error('다운로드 실패:', error);
                return false;
            }
        }
        async function saveWithPicker(blob, filename){ try{ const opts={ suggestedName: filename, types:[{ description:'ZIP file', accept:{'application/zip':['.zip']} }] }; const handle=await window.showSaveFilePicker(opts); const writable=await handle.createWritable(); await writable.write(blob); await writable.close(); return true; }catch(_){ return false; } }
        function detectInApp(){ 
            const uaRaw=navigator.userAgent||navigator.vendor||''; 
            const ua=uaRaw.toLowerCase(); 
            const isIOS=/iphone|ipad|ipod/.test(ua)||(navigator.platform==='MacIntel'&&navigator.maxTouchPoints>1); 
            const isAndroid=/android/.test(ua); 
            const isSamsung=/samsungbrowser/i.test(uaRaw); 
            const isKakao=/kakaotalk/.test(ua); 
            const isNaver=/naver/.test(ua); 
            const isFB=/fban|fbav|fb_iab/.test(ua); 
            const isIG=/instagram/.test(ua); 
            const isLine=/ line\//.test(ua); 
            const isIOSWebView=isIOS && !!window.webkit && !!window.webkit.messageHandlers && !/safari/i.test(uaRaw); 
            const isInApp=isKakao||isNaver||isFB||isIG||isLine||isIOSWebView; 
            return { isInApp, isIOS, isAndroid, isSamsung }; 
        }

        function isIOS() {
            const ua = navigator.userAgent || navigator.vendor || '';
            return /iphone|ipad|ipod/.test(ua.toLowerCase()) || 
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }

        async function shareToFilesApp(blob, filename) {
            try {
                // iOS에서 Web Share API를 우선적으로 사용하여 원버튼 클릭으로 파일 저장
                if (navigator.share && navigator.canShare) {
                    const file = new File([blob], filename, { type: 'application/zip' });
                    const shareData = {
                        files: [file],
                        title: filename,
                        text: 'ZIP 파일을 파일 앱에 저장하세요'
                    };
                    
                    if (navigator.canShare(shareData)) {
                        await navigator.share(shareData);
                        setStatus('✅ 파일이 파일 앱에 저장되었습니다.');
                        showToast('파일 앱에 저장 완료');
                        return true;
                    }
                }
                
                // Web Share API가 지원되지 않는 경우 - 다른 방법 시도
                console.log('Web Share API 미지원 또는 파일 공유 불가능');
                
                // 방법 1: File System Access API 시도 (iOS에서는 제한적)
                if (window.showSaveFilePicker) {
                    try {
                        const opts = {
                            suggestedName: filename,
                            types: [{
                                description: 'ZIP file',
                                accept: { 'application/zip': ['.zip'] }
                            }]
                        };
                        const handle = await window.showSaveFilePicker(opts);
                        const writable = await handle.createWritable();
                        await writable.write(blob);
                        await writable.close();
                        setStatus('✅ 파일이 저장되었습니다.');
                        showToast('파일 저장 완료');
                        return true;
                    } catch (pickerError) {
                        console.log('File System Access API 실패:', pickerError);
                    }
                }
                
                // 방법 2: 일반 다운로드 시도 (가장 안전한 방법)
                const success = triggerBlobDownload(blob, filename);
                if (success) {
                    setStatus('✅ ZIP 파일이 다운로드되었습니다. Safari 하단의 다운로드 아이콘을 눌러 파일 앱에 저장하세요.');
                    showToast('다운로드 완료 - Safari 하단 다운로드 아이콘을 눌러주세요');
                    return true;
                } else {
                    throw new Error('다운로드 실패');
                }
            } catch (error) {
                console.error('iOS 파일 공유 실패:', error);
                // 모든 방법이 실패한 경우에만 서버 다운로드로 전환
                console.log('모든 로컬 저장 방법 실패, 서버 다운로드로 전환');
                setStatus('로컬 저장 실패, 서버에서 다운로드합니다.');
                serverDownloadLastZip();
                return false;
            }
        }

        async function attemptLocalDownloadAndVerify(zipFilename){ 
            const env=detectInApp(); 
            if (env.isInApp){ 
                setStatus('로컬 다운로드가 제한되어 서버 다운로드로 전환합니다.'); 
                serverDownloadLastZip(); 
                return; 
            } 
            if (env.isIOS){ 
                setStatus('iOS에서 파일 앱으로 공유합니다.'); 
                if (lastZipBlob) await shareToFilesApp(lastZipBlob, zipFilename); 
                return; 
            }
            let localSaved=false; 
            let usedPicker=false; 
            if (window.showSaveFilePicker && lastZipBlob){ 
                usedPicker=true; 
                localSaved=await saveWithPicker(lastZipBlob, zipFilename); 
            }
            if (!localSaved && lastZipBlob){ 
                try{ 
                    localSaved=triggerBlobDownload(lastZipBlob, zipFilename)===true; 
                }catch(_){ 
                    localSaved=false; 
                } 
            }
            if (env.isAndroid || env.isSamsung){ 
                if (!usedPicker) localSaved=false; 
            }
            if (localSaved){ 
                setStatus('✅ 로컬 다운로드가 완료되었습니다.'); 
                showToast('로컬 다운로드 완료'); 
            } else { 
                setStatus('로컬 다운로드 실패 또는 제한됨, 서버에서 다운로드합니다.'); 
                serverDownloadLastZip(); 
            } 
        }

        function trackServerDownload(token, timeoutMs=5000){ const deadline=Date.now()+timeoutMs; const key=`download_ok_${encodeURIComponent(token)}=`; const timer=setInterval(()=>{ const found=document.cookie.includes(key); if (found){ clearInterval(timer); setStatus('✅ 로컬 저장(서버 첨부) 확인되었습니다.'); showToast('다운로드 완료 확인'); } else if (Date.now()>deadline){ clearInterval(timer); } }, 300); }

        function serverDownloadLastZip(){ try{ if (!lastZipBlob || !lastMeta?.zipFilename){ showToast('다운로드할 파일이 없습니다.'); return; } blobToBase64(lastZipBlob).then((b64)=>{ const token=`${Date.now()}_${Math.random().toString(36).slice(2,8)}`; trackServerDownload(token, 3500); const form=document.createElement('form'); form.method='POST'; form.action='/.netlify/functions/download'; form.target='_blank'; const add=(n,v)=>{ const i=document.createElement('input'); i.type='hidden'; i.name=n; i.value=v; form.appendChild(i); }; add('filename', lastMeta.zipFilename); add('mime', 'application/zip'); add('contentBase64', b64); add('token', token); document.body.appendChild(form); form.submit(); document.body.removeChild(form); showToast('서버에서 다운로드를 시작합니다.'); }).catch(()=>{ throw new Error('base64 변환 실패'); }); }catch(_){ showToast('서버 다운로드에 실패했습니다.'); }
        }

        let lastZipBlob=null; let lastMeta=null;

        async function handleZipDownloadAndSubmit(){ try{
            setStatus('학생 정보 검증 중…'); dom.retryUploadBtn.dataset.show=''; dom.retryUploadBtn.classList.add('hidden'); const form=validateForm(); if(!form) return; showProgress(true); setProgress(10,'문서 생성 준비...');
            const section=calcSectionCode(form.grade, form.klass); const studentId=calcStudentId(form.grade, form.klass, form.number); const docTitle='스마트 모빌리티 허브 아이디어 제안서 (2차시)';
            const fmt=new Intl.DateTimeFormat('ko-KR',{ timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false });
            const parts=Object.fromEntries(fmt.formatToParts(new Date()).map(p=>[p.type,p.value])); const timestamp=`${parts.year}${parts.month}${parts.day}_${parts.hour}${parts.minute}${parts.second}`;
            const baseName=`${studentId}_${form.name}_${docTitle}_${timestamp}`; const htmlFilename=`${baseName}.html`; const zipFilename=`${baseName}.zip`;
            setStatus('ZIP 파일 생성 중…'); setProgress(25,'ZIP 생성 중...'); const reportContent=document.getElementById('report-content').innerHTML; const docHtml=generateDocHtml(baseName, reportContent);
            const zip=new JSZip(); zip.file(htmlFilename, docHtml); const zipBlob=await zip.generateAsync({type:'blob', compression:'DEFLATE', compressionOptions:{level:6}}); lastZipBlob=zipBlob; lastMeta={ studentId, name:form.name, zipFilename, section };
            const sizeBytes=zipBlob.size; if (sizeBytes>8*1024*1024){ setStatus('업로드 실패: ZIP 용량 초과 (8MB)'); showToast('ZIP 용량이 8MB를 초과합니다.'); dom.retryUploadBtn.dataset.show='1'; dom.retryUploadBtn.classList.remove('hidden'); return; }
            setStatus('저장준비중입니다. 잠시 기다려 주세요'); setProgress(45,'업로드 준비...'); const b64=await blobToBase64(zipBlob);
            if (!zipFilename.toLowerCase().endsWith('.zip')){ setStatus('업로드 실패: 지원하지 않는 파일 형식'); showToast('ZIP 파일만 업로드할 수 있습니다.'); return; }
            const metaActivity=(ACTIVITY_INPUT_DEFAULT||'').trim();
            const inputActivity=(document.getElementById('submission_activity')?.value||'').trim();
            const activity=metaActivity || inputActivity;
            if(!activity){ setStatus('활동 폴더명이 비어 있습니다. 메타 또는 입력값을 지정하세요.'); showToast('활동 폴더명을 입력하거나 메타를 설정하세요.'); return; }
            const payload={ studentId:studentId, subject:SUBJECT, activity:activity, section:section, files:[{ filename:zipFilename, contentBase64:b64, mime:'application/zip' }] };
            setProgress(60,'업로드 중...'); const res=await fetch(ENDPOINT,{ method:'POST', headers:{ 'Content-Type':'application/json', 'X-Submission-Key':SUBMIT_KEY }, body:JSON.stringify(payload) });
            const text=await res.text(); let data={}; try{ data=JSON.parse(text); }catch(_){ data={ raw:text }; }
            if (!res.ok){ const errorMsg=data.error||data.detail||data.message||res.statusText||`HTTP ${res.status}`; throw new Error(`업로드 실패: ${errorMsg}`); }
            const uploadedFile=data.files?.[0]; const filePath=uploadedFile?.name||zipFilename; const fullPath=`/과제제출/${SUBJECT}/${activity}/${section}/${studentId}/${filePath}`;
            setStatus(`✅ 제출 완료! 저장 경로: ${fullPath} — 다운로드 확인 중…`); setProgress(85,'다운로드 준비...');
            attemptLocalDownloadAndVerify(zipFilename); setProgress(100,'완료'); setTimeout(()=>showProgress(false),1500);
        }catch(err){ const errorMessage=err?.message||err||'알 수 없는 오류'; setStatus(`❌ 제출 실패: ${errorMessage}`); showToast(`제출 실패: ${errorMessage}`); setProgress(0,''); showProgress(false); } }

        async function retryLastUpload(){ try{ if(!lastZipBlob||!lastMeta){ showToast('재시도할 항목이 없습니다.'); return; } setStatus('저장준비중입니다. 잠시 기다려 주세요'); showProgress(true); setProgress(45,'업로드 준비...'); const b64=await blobToBase64(lastZipBlob); const sizeBytes=bytesFromBase64(b64); if(sizeBytes>8*1024*1024){ setStatus('업로드 실패: ZIP 용량 초과 (8MB)'); showToast('ZIP 파일 용량이 8MB를 초과합니다.'); return; } const metaActivity=(ACTIVITY_INPUT_DEFAULT||'').trim(); const inputActivity=(document.getElementById('submission_activity')?.value||'').trim(); const activity=metaActivity || inputActivity; if(!activity){ setStatus('활동 폴더명이 비어 있습니다. 메타 또는 입력값을 지정하세요.'); showToast('활동 폴더명을 입력하거나 메타를 설정하세요.'); return; } const payload={ studentId:lastMeta.studentId, subject:SUBJECT, activity:activity, section:lastMeta.section, files:[{ filename:lastMeta.zipFilename, contentBase64:b64, mime:'application/zip' }] }; setProgress(60,'업로드 중...'); const res=await fetch(ENDPOINT,{ method:'POST', headers:{ 'Content-Type':'application/json', 'X-Submission-Key':SUBMIT_KEY }, body:JSON.stringify(payload) }); const text=await res.text(); let data={}; try{ data=JSON.parse(text); }catch(_){ data={ raw:text }; } if(!res.ok){ const reason=data.error||data.detail||data.message||res.statusText||'업로드 실패'; setStatus(`제출 실패: ${reason}`); showToast(`제출 실패: ${reason}`); return; } const uploadedFile=data.files?.[0]; const filePath=uploadedFile?.name||lastMeta.zipFilename; const fullPath=`/과제제출/${SUBJECT}/${activity}/${lastMeta.section}/${lastMeta.studentId}/${filePath}`; setStatus(`✅ 제출 완료! 저장 경로: ${fullPath} — 다운로드 확인 중…`); setProgress(85,'다운로드 준비...'); attemptLocalDownloadAndVerify(lastMeta.zipFilename); setProgress(100,'완료'); setTimeout(()=>showProgress(false),1500); }catch(err){ const errorMessage=err?.message||err||'알 수 없는 오류'; setStatus(`❌ 제출 실패: ${errorMessage}`); showToast(`제출 실패: ${errorMessage}`); } }
    });
    </script>
</body>
</html>

