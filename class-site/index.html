<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>교사 관리 포털</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- 로컬 개발 설정 (로컬 환경에서만 로드) -->
    <script>
        // 로컬 개발 환경 감지
        const isLocalDev = window.location.hostname === 'localhost' || 
                          window.location.hostname === '127.0.0.1' ||
                          window.location.hostname.includes('192.168') ||
                          window.location.protocol === 'file:';
        
        if (isLocalDev) {
            // 로컬 개발용 설정 로드 (배포 환경에서는 파일이 없을 수 있음)
            const script = document.createElement('script');
            script.src = 'local-dev-config.js';
            script.onerror = function() {
                console.warn('로컬 개발 설정 파일을 찾을 수 없습니다. 기본 설정을 사용합니다.');
                window.LOCAL_DEV_CONFIG = {
                    ADMIN_PASSWORD: 'teacher2024',
                    ENABLE_LOCAL_AUTH: true,
                    DEBUG_MODE: true
                };
            };
            script.onload = function() {
                console.log('로컬 개발 설정 파일이 로드되었습니다.');
            };
            document.head.appendChild(script);
        } else {
            // 프로덕션 환경에서는 로컬 설정을 사용하지 않음
            console.log('프로덕션 환경: Netlify Functions 사용');
        }
    </script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 로그인 화면 -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <div class="text-center mb-6">
                <div class="text-4xl mb-4">🔐</div>
                <h1 class="text-2xl font-bold text-gray-800">교사 관리 포털</h1>
                <p class="text-gray-600 mt-2">관리자 인증이 필요합니다</p>
                <div id="local-dev-notice" class="mt-3 p-2 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-700 hidden">
                    <strong>로컬 개발 모드:</strong> <code class="bg-blue-100 px-1 rounded">local-dev-config.js</code> 파일에서 암호를 확인하세요
                </div>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">관리자 암호</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="암호를 입력하세요" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                    로그인
                </button>
            </form>
            <div id="error-message" class="mt-4 text-red-600 text-sm text-center hidden"></div>
            
            <!-- 디버깅 정보 (개발용) -->
            <div id="debug-info" class="mt-4 text-xs text-gray-400 text-center hidden">
                <div>환경변수 상태: <span id="env-status">확인 중...</span></div>
                <div>API 엔드포인트: /.netlify/functions/auth</div>
            </div>
        </div>
    </div>

    <!-- 메인 포털 화면 -->
    <div id="main-portal" class="hidden">
        <div class="max-w-6xl mx-auto p-4 sm:p-6">
            <!-- 헤더 -->
            <header class="bg-white rounded-xl shadow-md p-6 mb-8">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">교사 관리 포털</h1>
                        <p class="text-gray-600 mt-1">과제 제출 현황 및 학생 관리</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-sm text-gray-500">
                            <span id="current-time"></span>
                        </div>
                        <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm">
                            로그아웃
                        </button>
                    </div>
                </div>
            </header>

            <!-- 교과별 활동 현황 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-indigo-100 rounded-lg">
                            <span class="text-2xl">⚛️</span>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">물리학II</p>
                            <p class="text-lg font-bold text-gray-800">활동 1개</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-green-100 rounded-lg">
                            <span class="text-2xl">🔬</span>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">과학탐구실험</p>
                            <p class="text-lg font-bold text-gray-800">활동 다수</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-purple-100 rounded-lg">
                            <span class="text-2xl">📚</span>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">전체 교과</p>
                            <p class="text-lg font-bold text-gray-800">2개 교과</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 교과별 관리 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- 물리학II 관리 -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-6 text-white">
                        <div class="flex items-center">
                            <span class="text-3xl mr-3">⚛️</span>
                            <div>
                                <h3 class="text-xl font-bold">물리학II</h3>
                                <p class="text-indigo-100 text-sm">2학기 수행평가 활동</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <a href="physics2/activity2/" class="block w-full bg-indigo-50 hover:bg-indigo-100 text-indigo-700 font-medium py-3 px-4 rounded-lg transition-colors text-center">
                                📰 최신 물리학, 공학 연관기사 탐구 발표
                            </a>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-medium text-gray-800 mb-2">활동 정보</h4>
                                <div class="text-sm text-gray-600 space-y-1">
                                    <div>• 활동 유형: 기사탐구 및 발표</div>
                                    <div>• 평가 요소: 과학적 정보 소양, 융합적 사고력</div>
                                    <div>• 제출 형태: ZIP 파일 (HTML + 발표 스크립트)</div>
                                    <div>• 발표 시간: 5-7분</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="previewActivity('physics2')" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                    👁️ 활동지 미리보기
                                </button>
                                <button onclick="editActivity('physics2')" class="bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors text-sm">
                                    ✏️ 활동지 편집
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 과학탐구실험 관리 -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="bg-gradient-to-r from-green-500 to-teal-600 p-6 text-white">
                        <div class="flex items-center">
                            <span class="text-3xl mr-3">🔬</span>
                            <div>
                                <h3 class="text-xl font-bold">과학탐구실험</h3>
                                <p class="text-green-100 text-sm">실험 및 탐구 활동</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <a href="science-experiments/" class="block w-full bg-green-50 hover:bg-green-100 text-green-700 font-medium py-3 px-4 rounded-lg transition-colors text-center">
                                🧪 과학탐구실험 교과 홈
                            </a>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-medium text-gray-800 mb-2">활동 정보</h4>
                                <div class="text-sm text-gray-600 space-y-1">
                                    <div>• 활동 유형: 다양한 과학 실험 및 탐구</div>
                                    <div>• 평가 요소: 실험 설계, 데이터 분석, 과학적 사고</div>
                                    <div>• 제출 형태: 실험 보고서 및 분석 자료</div>
                                    <div>• 활동 수: 다수의 실험 및 탐구 활동</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="previewActivity('science')" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                    👁️ 활동지 미리보기
                                </button>
                                <button onclick="editActivity('science')" class="bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors text-sm">
                                    ✏️ 활동지 편집
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 활동 관리 도구 -->
            <div class="bg-white rounded-xl shadow-md p-6 mt-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">활동 관리 도구</h3>
                    <div class="flex space-x-2">
                        <button onclick="createNewActivity()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                            ➕ 새 활동 추가
                        </button>
                        <button onclick="manageActivities()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors text-sm">
                            📋 활동 목록 관리
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- 활동 템플릿 -->
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex items-center mb-3">
                            <span class="text-2xl mr-2">📝</span>
                            <h4 class="font-medium text-gray-800">기본 활동지</h4>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">학생 정보 입력, 활동 내용 작성, 미리보기 기능이 포함된 기본 템플릿</p>
                        <button onclick="useTemplate('basic')" class="w-full bg-gray-100 text-gray-700 py-2 px-3 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                            템플릿 사용
                        </button>
                    </div>

                    <!-- 발표 활동 템플릿 -->
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex items-center mb-3">
                            <span class="text-2xl mr-2">🎤</span>
                            <h4 class="font-medium text-gray-800">발표 활동지</h4>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">발표 스크립트 작성 기능이 포함된 발표용 활동지 템플릿</p>
                        <button onclick="useTemplate('presentation')" class="w-full bg-gray-100 text-gray-700 py-2 px-3 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                            템플릿 사용
                        </button>
                    </div>

                    <!-- 실험 보고서 템플릿 -->
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex items-center mb-3">
                            <span class="text-2xl mr-2">🧪</span>
                            <h4 class="font-medium text-gray-800">실험 보고서</h4>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">실험 목적, 방법, 결과, 결론 작성이 포함된 실험 보고서 템플릿</p>
                        <button onclick="useTemplate('experiment')" class="w-full bg-gray-100 text-gray-700 py-2 px-3 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                            템플릿 사용
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 로그인 처리
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const password = document.getElementById('password').value.trim();
            const errorMessage = document.getElementById('error-message');
            const submitButton = e.target.querySelector('button[type="submit"]');
            
            // 입력값 검증
            if (!password) {
                errorMessage.textContent = '암호를 입력해주세요.';
                errorMessage.classList.remove('hidden');
                document.getElementById('password').focus();
                return;
            }
            
            // 로딩 상태 표시
            submitButton.disabled = true;
            submitButton.textContent = '인증 중...';
            submitButton.classList.add('opacity-75', 'cursor-not-allowed');
            errorMessage.classList.add('hidden');
            
            try {
                console.log('인증 요청 시작...');
                
                // 로컬 개발 환경 감지
                const isLocalDev = window.location.hostname === 'localhost' || 
                                 window.location.hostname === '127.0.0.1' ||
                                 window.location.hostname.includes('192.168') ||
                                 window.location.protocol === 'file:';
                
                if (isLocalDev) {
                    console.log('로컬 개발 환경 감지됨, 폴백 인증 사용');
                    // 로컬 개발용 폴백 인증 (설정 파일에서 암호 가져오기)
                    const localPassword = window.LOCAL_DEV_CONFIG?.ADMIN_PASSWORD || 'teacher2024';
                    if (password === localPassword) {
                        console.log('로컬 인증 성공');
                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('main-portal').classList.remove('hidden');
                        document.getElementById('main-portal').classList.add('fade-in');
                        
                        // 성공 메시지 표시
                        setTimeout(() => {
                            const successToast = document.createElement('div');
                            successToast.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                            successToast.textContent = '로그인 성공! (로컬 모드)';
                            document.body.appendChild(successToast);
                            setTimeout(() => successToast.remove(), 2000);
                        }, 100);
                    } else {
                        console.log('로컬 인증 실패');
                        errorMessage.textContent = '잘못된 암호입니다. 로컬 개발용 암호를 확인하세요.';
                        errorMessage.classList.remove('hidden');
                        document.getElementById('password').value = '';
                        document.getElementById('password').focus();
                    }
                } else {
                    // 프로덕션 환경: Netlify Functions 사용
                    const response = await fetch('/.netlify/functions/auth', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ password })
                    });
                    
                    console.log('응답 상태:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    console.log('서버 응답:', result);
                    
                    if (result.success) {
                        // 로그인 성공
                        console.log('인증 성공');
                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('main-portal').classList.remove('hidden');
                        document.getElementById('main-portal').classList.add('fade-in');
                        
                        // 성공 메시지 표시
                        setTimeout(() => {
                            const successToast = document.createElement('div');
                            successToast.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                            successToast.textContent = '로그인 성공!';
                            document.body.appendChild(successToast);
                            setTimeout(() => successToast.remove(), 2000);
                        }, 100);
                    } else {
                        // 로그인 실패
                        console.log('인증 실패:', result.error);
                        errorMessage.textContent = result.error || '잘못된 암호입니다. 다시 시도해주세요.';
                        errorMessage.classList.remove('hidden');
                        document.getElementById('password').value = '';
                        document.getElementById('password').focus();
                    }
                }
            } catch (error) {
                console.error('인증 오류:', error);
                
                // 구체적인 에러 메시지 제공
                let errorText = '네트워크 오류가 발생했습니다.';
                if (error.message.includes('Failed to fetch')) {
                    errorText = '서버에 연결할 수 없습니다. 로컬 개발 환경에서는 암호 "teacher2024"를 사용하세요.';
                } else if (error.message.includes('HTTP 500')) {
                    errorText = '서버 오류가 발생했습니다. 잠시 후 다시 시도해주세요.';
                } else if (error.message.includes('HTTP 401')) {
                    errorText = '인증에 실패했습니다. 암호를 확인해주세요.';
                }
                
                errorMessage.textContent = errorText;
                errorMessage.classList.remove('hidden');
            } finally {
                // 로딩 상태 해제
                submitButton.disabled = false;
                submitButton.textContent = '로그인';
                submitButton.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        });

        // 로그아웃 처리
        document.getElementById('logout-btn').addEventListener('click', function() {
            document.getElementById('main-portal').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('password').value = '';
            document.getElementById('error-message').classList.add('hidden');
        });

        // 현재 시간 업데이트
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('current-time').textContent = timeString;
        }

        // 활동 관리 기능들
        function previewActivity(subject) {
            if (subject === 'physics2') {
                window.open('physics2/activity2/', '_blank');
            } else if (subject === 'science') {
                window.open('science-experiments/', '_blank');
            }
        }

        function editActivity(subject) {
            if (subject === 'physics2') {
                alert('물리학II 활동지 편집 기능을 준비 중입니다.');
            } else if (subject === 'science') {
                alert('과학탐구실험 활동지 편집 기능을 준비 중입니다.');
            }
        }

        function createNewActivity() {
            alert('새 활동 생성 기능을 준비 중입니다.\n\n기능:\n• 활동 제목 및 설명 설정\n• 평가 요소 선택\n• 활동지 템플릿 적용\n• 제출 형태 설정');
        }

        function manageActivities() {
            alert('활동 목록 관리 기능을 준비 중입니다.\n\n기능:\n• 기존 활동 목록 보기\n• 활동 활성화/비활성화\n• 활동 순서 변경\n• 활동 삭제');
        }

        function useTemplate(templateType) {
            const templates = {
                'basic': '기본 활동지 템플릿을 사용합니다.',
                'presentation': '발표 활동지 템플릿을 사용합니다.',
                'experiment': '실험 보고서 템플릿을 사용합니다.'
            };
            
            alert(templates[templateType] + '\n\n템플릿 적용 기능을 준비 중입니다.');
        }

        // 환경변수 상태 확인 (개발용)
        async function checkEnvironmentStatus() {
            const debugInfo = document.getElementById('debug-info');
            const envStatus = document.getElementById('env-status');
            
            // 로컬 개발 환경 감지
            const isLocalDev = window.location.hostname === 'localhost' || 
                             window.location.hostname === '127.0.0.1' ||
                             window.location.hostname.includes('192.168') ||
                             window.location.protocol === 'file:';
            
            if (isLocalDev) {
                envStatus.textContent = '로컬 모드 (폴백 인증)';
                envStatus.className = 'text-blue-500';
                debugInfo.classList.remove('hidden');
                
                // 로컬 개발 안내 메시지 표시
                const localNotice = document.getElementById('local-dev-notice');
                if (localNotice) {
                    localNotice.classList.remove('hidden');
                }
                return;
            }
            
            try {
                const response = await fetch('/.netlify/functions/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: 'test' })
                });
                
                if (response.status === 401) {
                    envStatus.textContent = '정상 (환경변수 설정됨)';
                    envStatus.className = 'text-green-500';
                } else if (response.status === 500) {
                    envStatus.textContent = '서버 오류';
                    envStatus.className = 'text-red-500';
                } else {
                    envStatus.textContent = '상태 불명';
                    envStatus.className = 'text-yellow-500';
                }
                
                // 개발 환경에서만 디버깅 정보 표시
                if (isLocalDev) {
                    debugInfo.classList.remove('hidden');
                }
            } catch (error) {
                console.log('환경변수 상태 확인 실패:', error);
                envStatus.textContent = '연결 실패';
                envStatus.className = 'text-red-500';
            }
        }

        // 시간 업데이트 시작
        setInterval(updateCurrentTime, 1000);
        updateCurrentTime();
        
        // 환경변수 상태 확인
        checkEnvironmentStatus();

        // ESC 키로 로그아웃
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && !document.getElementById('main-portal').classList.contains('hidden')) {
                document.getElementById('logout-btn').click();
            }
        });
    </script>
</body>
</html>
