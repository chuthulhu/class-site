<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>첫걸음, 마지막 걸음 프로젝트 허브</title>
    <!-- Submission Subject (easily editable) -->
    <meta name="submission-subject" content="과학탐구실험2">
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="모빌리티 허브">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ZIP 생성을 위한 라이브러리 추가 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- 모듈화된 유틸리티 -->
    <script type="module" src="./modules/ui-utils.js"></script>
    <script type="module" src="./modules/file-utils.js"></script>
    <script type="module" src="./modules/upload-manager.js"></script>
    <script type="module" src="./modules/image-processor.js"></script>
    <!-- Google Fonts - Noto Sans KR & Nanum Myeongjo for serif font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Nanum+Myeongjo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* --- 탭 버튼 스타일 (from index.html) --- */
        .tab-button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem; /* 8px */
            background-color: #e5e7eb; /* gray-200 */
            padding: 0.5rem;
            border-radius: 0.75rem; /* 12px */
        }
        .tab-button {
            flex-grow: 1;
            text-align: center;
            padding: 0.75rem 0.5rem;
            border-radius: 0.5rem; /* 8px */
            font-weight: 500;
            color: #4b5563; /* gray-600 */
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .tab-button:hover {
            background-color: #f9fafb; /* gray-50 */
            color: #1f2937; /* gray-800 */
        }
        .tab-button.active {
            background-color: #ffffff;
            color: #4f46e5; /* indigo-600 */
            font-weight: 700;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* --- Styles from a previous version (수행평가3.html) --- */
        .tip-card {
            background: linear-gradient(135deg, #f5f3ff, #eef2ff);
            border-left: 4px solid #6366f1;
        }
        .name-explainer-card {
             background-color: #f0fdf4;
             border-left: 4px solid #22c55e;
             padding: 1.5rem;
             border-radius: 0.5rem;
        }
        .infographic-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .step-icon {
            background-color: #4f46e5;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        .accordion-header button.open {
            background-color: #eef2ff;
            color: #4338ca;
        }
        .accordion-content {
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            max-height: 0;
            overflow: hidden;
        }
        .accordion-content.open {
            max-height: 1500px;
        }
        
        /* 이미지 업로드 스타일 */
        .image-slot {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background-color: #f9fafb;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .image-slot:hover {
            border-color: #4f46e5;
            background-color: #f0f4ff;
            transform: translateY(-2px);
        }
        
        .image-slot.dragover {
            border-color: #10b981;
            background-color: #ecfdf5;
            transform: scale(1.02);
        }
        
        .image-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #6b7280;
        }
        
        .image-preview {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .preview-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .image-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            color: white;
            padding: 8px;
            border-radius: 0 0 8px 8px;
        }
        
        .image-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .filename {
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-size, .dimensions {
            font-size: 10px;
            opacity: 0.8;
        }
        
        .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }
        
        .remove-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }
        
        .image-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #6b7280;
        }
        
        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .image-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #ef4444;
            text-align: center;
        }
        
        .error-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .error-message {
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .retry-btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .retry-btn:hover {
            background: #4338ca;
        }
        
        /* 활동지 입력 필드 스타일 */
        textarea, input[type="text"], select {
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        textarea:focus, input[type="text"]:focus, select:focus {
            border-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
            outline: none;
        }
        
        /* --- 미리보기(리포트) 스타일 (from index.html) --- */
        .report-page {
            background-color: white;
            padding: 2.5cm 2cm;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            color: #1f2937;
        }
        .report-main-title {
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 2.25rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1rem;
            border-bottom: 2px solid #111827;
            padding-bottom: 1rem;
        }
        .report-section-title {
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            margin-top: 2.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #d1d5db;
        }
        .preview-text {
            white-space: pre-wrap;
            word-break: break-word;
            min-height: 2.5em;
            line-height: 1.8;
            color: #374151;
            font-family: 'Nanum Myeongjo', serif; /* 본문은 명조체 유지 */
        }
        .preview-placeholder {
            color: #9ca3af;
            font-style: italic;
        }
        
        /* 인쇄 설정 */
        @page {
            size: A4 portrait; margin: 2cm;
        }
        @media print {
            body * { visibility: hidden; }
            .printable-area, .printable-area * { visibility: visible; }
            .printable-area {
                position: absolute; left: 0; top: 0;
                width: 100%; padding: 0; margin: 0;
                box-shadow: none; border: none;
            }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-5xl mx-auto">
        <header class="text-center bg-white p-8 rounded-xl shadow-lg mb-6 no-print">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">첫걸음, 마지막 걸음 프로젝트</h1>
            <p class="text-lg text-gray-600 mt-2">S-BRT와 공유 PM 연계를 위한 종합 안내</p>
            <div class="mt-4 flex flex-wrap gap-3 justify-center" id="session_links_wrapper">
                <a id="session1_link" href="./session1.html" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 hidden" aria-disabled="true">1차시 활동 (현황 분석·고려사항)</a>
                <a id="session2_link" href="./session2.html" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 hidden" aria-disabled="true">2차시 활동 (3가지 지렛대·기대효과)</a>
                <span id="session_locked_notice" class="px-4 py-2 bg-gray-300 text-gray-600 rounded-lg select-none">활동 버튼은 10/13 00:00 공개 예정</span>
            </div>
        </header>
        
        

        <!-- Tab Navigation (허브: 배경/문제/가이드만) -->
        <div class="mb-8 no-print">
            <div class="tab-button-group" aria-label="Tabs">
                <button class="tab-button active" data-tab="tab1">1. 배경 및 현황</button>
                <button class="tab-button" data-tab="tab2">2. 프로젝트 문제</button>
                <button class="tab-button" data-tab="tab3">3. 공략 가이드</button>
            </div>
        </div>

        <!-- Tab Content -->
        <main>
            <!-- Tab 1: 배경 및 현황 (Content Filled) -->
            <div id="tab1" class="tab-content active">
                <div class="bg-white p-6 sm:p-8 rounded-lg shadow-md space-y-12">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">🤔 혹시, 당신의 등하굣길은 어떤가요?</h2>
                        <div class="bg-indigo-50 border-l-4 border-indigo-400 p-6 rounded-lg space-y-3 text-gray-700">
                            <p>"아침에 버스 타러 가는데, 인도 한가운데 킥보드가 넘어져 있어서 짜증 났던 적."</p>
                            <p>"버스를 기다리는데, 정류장 앞에 킥보드가 여러 대 널려 있어서 타기 불편했던 적."</p>
                            <p>"학원 갈 때 킥보드 타고 S-BRT 정류장까지 가면 편할 것 같은데, 막상 타려고 하면 근처에 없거나 배터리가 없어서 포기한 적."</p>
                            <p class="pt-2 font-semibold">이런 경험, 한 번쯤 있지 않나요? 이 작은 불편함들이 바로 우리가 해결하려는 도시 문제의 시작입니다.</p>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">S-BRT: 빛과 그림자</h2>
                        <p class="text-gray-600 mb-6">창원 S-BRT는 대중교통의 효율을 높였지만, 새로운 문제도 낳았습니다. 그 성과를 인포그래픽으로 살펴봅시다.</p>
                        <div class="bg-gray-50 p-6 rounded-xl">
                            <div class="relative flex items-end justify-center">
                                <div class="w-1/2 pr-4 text-center">
                                    <h3 class="text-lg font-bold text-blue-600">긍정적 효과 (빛) ⬆️</h3>
                                    <div class="mt-4 space-y-3">
                                        <div class="bg-blue-100 p-3 rounded-lg"><p class="text-2xl">🚌</p><p class="font-semibold text-blue-800">버스 통행시간 단축</p><p class="text-xl font-bold text-blue-600">-5분 58초</p></div>
                                        <div class="bg-blue-100 p-3 rounded-lg"><p class="text-2xl">📈</p><p class="font-semibold text-blue-800">버스 이용객 증가</p><p class="text-xl font-bold text-blue-600">+16.2%</p></div>
                                    </div>
                                </div>
                                <div class="w-1/2 pl-4 text-center transform -translate-y-10">
                                    <h3 class="text-lg font-bold text-red-600">부정적 효과 (그림자) ⬇️</h3>
                                    <div class="mt-4">
                                        <div class="bg-red-100 p-3 rounded-lg"><p class="text-2xl">🚗</p><p class="font-semibold text-red-800">승용차 통행시간 증가</p><p class="text-xl font-bold text-red-600">+6분 12초</p></div>
                                    </div>
                                </div>
                            </div>
                            <div class="h-2 bg-gray-400 rounded-full transform -skew-y-3"></div>
                            <div class="w-0 h-0 border-l-[25px] border-l-transparent border-r-[25px] border-r-transparent border-b-[43.3px] border-b-gray-500 mx-auto"></div>
                            <p class="text-center text-sm text-gray-600 mt-4">S-BRT 도입으로 버스는 빨라졌지만, 그만큼 승용차는 느려지는 <strong>'풍선 효과'</strong>가 발생했습니다. 한쪽을 누르면 다른 쪽이 부풀어 오르는 것처럼, 도로 공간의 변화가 서로 다른 영향을 미친 것입니다.</p>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">공유 PM: 편리함 속 무질서</h2>
                        <p class="text-gray-600 mb-6">공유 킥보드와 자전거는 단거리 이동을 편리하게 만들었지만, 무분별한 주차 문제라는 그림자를 만들었습니다.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="infographic-card"><span class="text-5xl mb-3">✅</span><h3 class="text-lg font-bold text-gray-800">기회: 유연한 이동성</h3><p class="text-gray-600 mt-2">앱으로 간편하게 대여/반납하며, 버스가 닿지 않는 곳까지 연결하는 편리함을 제공합니다.</p></div>
                            <div class="infographic-card"><span class="text-5xl mb-3">⚠️</span><h3 class="text-lg font-bold text-gray-800">위기: 도시의 무질서</h3><p class="text-gray-600 mt-2">보도, 건물 입구 등에 무질서하게 방치되어 보행 안전을 위협하고 도시 미관을 해칩니다.</p></div>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">문제의 본질: 끊어진 '첫걸음'과 '마지막 걸음'</h2>
                        <p class="text-gray-600 mb-6">대중교통의 진정한 성공은 '문 앞에서 문 앞까지(Door-to-Door)'의 여정이 얼마나 편리한가에 달려있습니다. 집에서 나와 버스 정류장까지 가는 <strong>'첫걸음(First Mile)'</strong>과, 정류장에서 내려 최종 목적지까지 가는 <strong>'마지막 걸음(Last Mile)'</strong>이 바로 그 핵심입니다. S-BRT는 간선도로 구간의 이동 시간은 단축했지만, 이 '첫걸음'과 '마지막 걸음'의 불편함은 해결하지 못했습니다. 바로 이 끊어진 연결고리가 시민들이 자가용의 유혹을 뿌리치지 못하는 가장 큰 이유입니다.</p>
                        <div class="bg-gray-50 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-center text-gray-800 mb-4">하나의 완전한 여정: First Mile to Last Mile</h3>
                            <div class="flex items-center justify-between text-center text-xs sm:text-sm">
                                <div class="flex flex-col items-center w-1/5"><span class="text-4xl">🏠</span><p class="font-bold mt-1">집</p></div>
                                <div class="flex-1 text-gray-400">•••<p class="font-semibold text-blue-600">첫걸음</p>•••</div>
                                <div class="flex flex-col items-center w-1/5"><span class="text-4xl">🛴</span><p class="font-bold mt-1">공유PM</p></div>
                                <div class="flex-1 text-red-500 font-bold text-lg">X</div>
                                <div class="flex flex-col items-center w-1/5"><span class="text-4xl">🚏</span><p class="font-bold mt-1">S-BRT</p></div>
                                <div class="flex-1 text-red-500 font-bold text-lg">X</div>
                                <div class="flex flex-col items-center w-1/5"><span class="text-4xl">🛴</span><p class="font-bold mt-1">공유PM</p></div>
                                <div class="flex-1 text-gray-400">•••<p class="font-semibold text-green-600">마지막 걸음</p>•••</div>
                                <div class="flex flex-col items-center w-1/5"><span class="text-4xl">🏢</span><p class="font-bold mt-1">목적지</p></div>
                            </div>
                             <p class="text-center text-red-600 font-semibold mt-4">현재 공유 PM과 S-BRT의 연계가 끊어져, 시민들의 여정은 불편하고 도시는 무질서해지고 있습니다.<br> 이 문제를 해결하는 것이 우리 프로젝트의 핵심입니다.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: 프로젝트 문제 제시 (Content Filled) -->
            <div id="tab2" class="tab-content">
                <div class="bg-white p-6 sm:p-8 rounded-lg shadow-md space-y-12">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">프로젝트 개요: 도시교통 컨설턴트 되기</h2>
                        <p class="text-gray-700 mt-2">여러분은 창원시의 도시교통 컨설턴트가 되어, 'S-BRT와 공유 PM의 단절'이라는 실제 도시 문제를 해결하기 위한 창의적인 아이디어 제안서를 작성합니다.</p>
                    </div>
                    <div class="name-explainer-card">
                        <h3 class="font-bold text-lg text-green-800 mb-2">💡 프로젝트 이름: 첫걸음, 마지막 걸음</h3>
                        <p class="text-green-700">이 이름은 교통 분야의 중요 개념인 <strong>'퍼스트 마일, 라스트 마일(First Mile, Last Mile)'</strong>에서 영감을 얻었습니다. 집에서 나와 대중교통을 타기까지의 여정(<strong>첫걸음</strong>)과, 대중교통에서 내려 최종 목적지까지 가는 여정(<strong>마지막 걸음</strong>)을 의미합니다. 이 프로젝트의 목표는 바로 이 '첫걸음과 마지막 걸음'을 공유 PM과 연계하여 완벽하고 편리한 이동 경험으로 만드는 것입니다.</p>
                    </div>
                    
                    <div class="space-y-6">
                        <h3 class="text-xl font-bold text-indigo-700 border-b-2 border-indigo-200 pb-3">프로젝트 과제: 스마트 모빌리티 허브 아이디어 제안</h3>
                        <p class="text-gray-600">
                            <strong>과제 목표:</strong> '스마트 모빌리티 허브' 시범사업을 성공시키기 위해, <strong>현실적인 문제 상황을 분석</strong>하고, <strong>'대상지 선정을 위한 고려사항'</strong>을 2가지 이상 제안하며, 이를 바탕으로 구체적인 솔루션과 기대효과를 작성합니다.
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center mt-4">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <span class="text-4xl">📊</span>
                                <h4 class="font-bold mt-2">1. 현황 분석</h4>
                                <p class="text-sm text-gray-600 mt-1">문제의 심각성과 중요성을 파악하여 정리합니다.</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <span class="text-4xl">🤔</span>
                                <h4 class="font-bold mt-2">2. 선정 기준 제시</h4>
                                <p class="text-sm text-gray-600 mt-1">어떤 곳에 허브를 설치해야 성공할지, 그 기준을 제시합니다.</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <span class="text-4xl">💡</span>
                                <h4 class="font-bold mt-2">3. 솔루션 제안</h4>
                                <p class="text-sm text-gray-600 mt-1">'3가지 지렛대'를 활용해 구체적인 아이디어를 제시합니다.</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <span class="text-4xl">📈</span>
                                <h4 class="font-bold mt-2">4. 기대 효과 작성</h4>
                                <p class="text-sm text-gray-600 mt-1">아이디어가 실현되었을 때의 긍정적 변화를 예측합니다.</p>
                            </div>
                        </div>
                         <div class="text-center mt-6"><p class="font-semibold text-gray-800"><strong>최종 결과물:</strong> '스마트 모빌리티 허브 아이디어 제안서'</p></div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: 프로젝트 공략 가이드 (Content Filled) -->
            <div id="tab3" class="tab-content">
                <div class="bg-white p-6 sm:p-8 rounded-lg shadow-md">
                    <section>
                        <h2 class="text-2xl font-bold text-indigo-700 mb-4 flex items-center">
                            <span class="step-icon mr-3">🚀</span>
                            아이디어 제안서 작성 가이드
                        </h2>
                        <div class="bg-white p-6 rounded-lg shadow-sm space-y-4">
                            <p class="text-gray-700">이 프로젝트의 핵심은 정해진 답을 찾는 것이 아니라, 여러분의 창의적인 생각과 논리를 자유롭게 펼치는 것입니다. 아래 가이드를 참고하여 멋진 아이디어를 구체화해 보세요.</p>
                            
                            <div class="accordion-item border-t pt-4">
                                <div class="accordion-header"><button class="w-full text-left p-4 rounded-lg font-semibold text-lg text-gray-800 hover:bg-gray-100 flex justify-between items-center"><span>📊 1. '현황 분석'은 어떻게 할까?</span><svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button></div>
                                <div class="accordion-content"><div class="p-4 text-gray-600 space-y-3">
                                    <p>좋은 해결책은 정확한 문제 인식에서 시작됩니다. 왜 지금 S-BRT와 공유 PM의 연계가 중요한 문제인지, 최신 뉴스 기사나 자료를 참고하여 자신의 언어로 정리해보세요.</p>
                                    <div class="tip-card p-4 rounded-lg">
                                        <h4 class="font-bold text-indigo-800">생각을 넓히는 질문</h4>
                                        <ul class="list-disc list-inside mt-2 text-sm">
                                            <li>최근 창원시 S-BRT나 공유 PM과 관련하여 어떤 뉴스들이 있었나요?</li>
                                            <li>시민들은 이 문제에 대해 어떤 불편을 겪고 있을까요?</li>
                                            <li>이 문제를 해결하지 않으면 미래에 어떤 더 큰 문제가 발생할 수 있을까요?</li>
                                        </ul>
                                    </div>
                                </div></div>
                            </div>

                            <div class="accordion-item border-t pt-4">
                                <div class="accordion-header"><button class="w-full text-left p-4 rounded-lg font-semibold text-lg text-gray-800 hover:bg-gray-100 flex justify-between items-center"><span>🤔 2. '대상지 선정을 위한 고려사항'은 어떻게 정할까?</span><svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button></div>
                                <div class="accordion-content"><div class="p-4 text-gray-600 space-y-3">
                                    <p>만약 여러분이 창원시장이라면, 한정된 예산으로 '스마트 모빌리티 허브'를 딱 한 곳에만 설치해야 합니다. 어떤 기준으로 그 장소를 골라야 시범사업이 성공하고, 시민들에게 가장 큰 도움이 될까요? 그 기준을 정하는 것이 이번 활동의 핵심입니다.</p>
                                    <div class="tip-card p-4 rounded-lg">
                                        <h4 class="font-bold text-indigo-800">생각을 넓히는 질문</h4>
                                        <ul class="list-disc list-inside mt-2 text-sm">
                                            <li>누가 허브를 가장 많이 이용할까요? (학생, 직장인, 주민 등)</li>
                                            <li>어떤 문제를 가장 시급하게 해결해야 할까요? (안전, 불편, 도시 미관 등)</li>
                                            <li>어디에 설치해야 눈에 잘 띄고 더 많은 사람이 이용할 수 있을까요?</li>
                                        </ul>
                                    </div>
                                </div></div>
                            </div>

                            <div class="accordion-item border-t pt-4">
                                <div class="accordion-header"><button class="w-full text-left p-4 rounded-lg font-semibold text-lg text-gray-800 hover:bg-gray-100 flex justify-between items-center"><span>💡 3. '3가지 지렛대' 아이디어 내기</span><svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button></div>
                                <div class="accordion-content"><div class="p-4 text-gray-600 space-y-4">
                                    <p>하나의 좋은 아이디어는 여러 요소가 결합되었을 때 나옵니다. '공간', '혜택', '협력'이라는 3가지 관점에서 아이디어를 자유롭게 상상해보세요.</p>
                                    <p><strong>🏛️ 물리적 인프라 (공간):</strong> "예쁜 디자인의 비가림막과 스마트폰 충전기를 설치하자!", "CCTV와 조명을 설치해서 밤에도 안전하게 만들자!"</p>
                                    <p><strong>💡 디지털/정책 (혜택):</strong> "허브에 주차하면 킥보드 요금을 할인해주자!", "S-BRT로 환승하면 추가 포인트를 주는 앱을 만들자!"</p>
                                    <p><strong>🤝 운영 모델 (협력):</strong> "창원시, 킥보드 회사, 버스 회사가 함께 운영 비용을 부담하자!", "허브 주변 카페와 제휴해서 할인 쿠폰을 주자!"</p>
                                </div></div>
                            </div>

                            <div class="accordion-item border-t pt-4">
                                <div class="accordion-header"><button class="w-full text-left p-4 rounded-lg font-semibold text-lg text-gray-800 hover:bg-gray-100 flex justify-between items-center"><span>📈 4. 기대 효과, 어떻게 쓸까?</span><svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button></div>
                                <div class="accordion-content"><div class="p-4 text-gray-600 space-y-3">
                                    <p>여러분의 아이디어가 만들어 낼 긍정적인 미래를 상상해서 적어보세요. 거창하지 않아도 괜찮아요. 구체적인 모습을 그려보는 것이 중요합니다.</p>
                                     <div class="tip-card p-4 rounded-lg">
                                        <h4 class="font-bold text-indigo-800">생각을 넓히는 질문</h4>
                                        <ul class="list-disc list-inside mt-2 text-sm">
                                            <li>여러분의 아이디어가 실현되면 누가 가장 좋아할까요?</li>
                                            <li>도시의 모습은 어떻게 바뀔까요? (예: 깨끗해진다, 활기차진다 등)</li>
                                            <li>사람들의 생활은 어떻게 더 편리해질까요?</li>
                                        </ul>
                                    </div>
                                </div></div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Tab 4: 프로젝트 활동지 -->
            <div id="tab4" class="tab-content">
                <div class="bg-white p-6 sm:p-10 rounded-lg shadow-md space-y-8">
                    <header class="text-center mb-10">
                        <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">스마트 모빌리티 허브 아이디어 제안서</h1>
                        <p class="text-lg text-gray-600 mt-2">첫걸음, 마지막 걸음 프로젝트 활동지</p>
                    </header>
                    
                    <section>
                        <h2 class="text-2xl font-bold text-indigo-700 mb-4">1. 현황 분석 및 문제 인식</h2>
                        <div>
                            <label for="field_analysis" class="font-semibold text-gray-700 block mb-2">S-BRT와 공유 PM 연계 문제의 현황과 중요성</label>
                            <textarea id="field_analysis" rows="6" placeholder="최신 뉴스나 자료를 참고하여, 현재 창원시의 S-BRT와 공유 PM 연계 문제가 왜 중요하고 시급한지 자신의 언어로 분석하여 작성해보세요." class="w-full p-3 border border-gray-300 rounded-md"></textarea>
                        </div>
                    </section>

                    <section>
                        <h2 class="text-2xl font-bold text-indigo-700 mb-4">2. 시범사업 대상지 선정을 위한 고려사항</h2>
                        <p class="text-gray-600 mb-6">스마트 모빌리티 허브 시범사업을 성공시키기 위해, 어떤 기준으로 대상지를 선정해야 할지 <strong>2가지 이상의 고려사항</strong>과 그 이유를 구체적으로 작성하세요.</p>
                        <div class="space-y-6">
                             <div>
                                <label for="field_c1_title" class="font-semibold text-gray-700 block mb-2">고려사항 1</label>
                                <input type="text" id="field_c1_title" class="w-full p-3 border border-gray-300 rounded-md" placeholder="첫 번째 기준을 한 문장으로 작성하세요.">
                                <textarea id="field_c1_desc" rows="4" placeholder="왜 이 기준이 중요하다고 생각하나요? 구체적인 이유를 설명해주세요." class="w-full p-3 mt-2 border border-gray-300 rounded-md"></textarea>
                            </div>
                            <div>
                                <label for="field_c2_title" class="font-semibold text-gray-700 block mb-2">고려사항 2</label>
                                <input type="text" id="field_c2_title" class="w-full p-3 border border-gray-300 rounded-md" placeholder="두 번째 기준을 한 문장으로 작성하세요.">
                                <textarea id="field_c2_desc" rows="4" placeholder="왜 이 기준이 중요하다고 생각하나요? 구체적인 이유를 설명해주세요." class="w-full p-3 mt-2 border border-gray-300 rounded-md"></textarea>
                            </div>
                        </div>
                    </section>
            
                    <section>
                        <h2 class="text-2xl font-bold text-indigo-700 mb-4">3. 스마트 모빌리티 허브 아이디어 (3가지 지렛대)</h2>
                        <div class="space-y-6">
                            <div>
                                <label for="field_idea_infra" class="font-semibold text-gray-700 block mb-2">🏛️ 물리적 인프라 (공간)</label>
                                <textarea id="field_idea_infra" rows="5" placeholder="안전하고 편리하며 매력적인 '공간'을 만들기 위한 아이디어를 작성해보세요. (예: 디자인, 편의시설, 안전장치 등)" class="w-full p-3 border border-gray-300 rounded-md"></textarea>
                            </div>
                            <div>
                                <label for="field_idea_policy" class="font-semibold text-gray-700 block mb-2">💡 디지털/정책 (혜택)</label>
                                <textarea id="field_idea_policy" rows="5" placeholder="사람들이 허브를 '자발적으로' 이용하게 만들 아이디어를 작성해보세요. (예: 요금 할인, 포인트, 앱 연동, 주차 규칙 등)" class="w-full p-3 border border-gray-300 rounded-md"></textarea>
                            </div>
                            <div>
                                <label for="field_idea_operation" class="font-semibold text-gray-700 block mb-2">🤝 운영 모델 (협력)</label>
                                <textarea id="field_idea_operation" rows="5" placeholder="이 허브를 '지속가능하게' 운영하기 위한 아이디어를 작성해보세요. (예: 시/기업 역할 분담, 주변 상점과 제휴 등)" class="w-full p-3 border border-gray-300 rounded-md"></textarea>
                            </div>
                        </div>
                    </section>
            
                    <section>
                        <h2 class="text-2xl font-bold text-indigo-700 mb-4">4. 기대 효과</h2>
                        <div>
                            <label for="field_effects" class="font-semibold text-gray-700 block mb-2">아이디어 실현 후 예상되는 긍정적 변화</label>
                            <textarea id="field_effects" rows="6" placeholder="제안한 허브가 성공적으로 도입되었을 때 예상되는 긍정적인 변화를 자유롭게 상상하여 작성해보세요." class="w-full p-3 border border-gray-300 rounded-md"></textarea>
                        </div>
                    </section>
                    
                    <!-- [NEW] 이미지 업로드 섹션 -->
                    <section>
                        <h2 class="text-2xl font-bold text-indigo-700 mb-4">5. 실험 사진 및 자료</h2>
                        <p class="text-gray-600 mb-6">실험 과정이나 결과를 보여주는 사진을 업로드하세요. 드래그 앤 드롭 또는 클릭하여 업로드할 수 있습니다.</p>
                        <div class="image-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="image-slot" data-slot="1">
                                <div class="image-placeholder">
                                    <i class="camera-icon text-4xl mb-2">📷</i>
                                    <p class="text-sm text-gray-600">실험 과정 사진</p>
                                </div>
                                <input type="file" accept="image/*" class="image-input" hidden>
                            </div>
                            
                            <div class="image-slot" data-slot="2">
                                <div class="image-placeholder">
                                    <i class="camera-icon text-4xl mb-2">📷</i>
                                    <p class="text-sm text-gray-600">실험 결과 사진</p>
                                </div>
                                <input type="file" accept="image/*" class="image-input" hidden>
                            </div>
                            
                            <div class="image-slot" data-slot="3">
                                <div class="image-placeholder">
                                    <i class="camera-icon text-4xl mb-2">📷</i>
                                    <p class="text-sm text-gray-600">추가 자료</p>
                                </div>
                                <input type="file" accept="image/*" class="image-input" hidden>
                            </div>
                        </div>
                    </section>
                    
                    <!-- [NEW] 출처 추가 섹션 from index.html -->
                    <section>
                        <h2 class="text-2xl font-bold text-indigo-700 mb-4">6. 정보 출처</h2>
                        <div>
                            <div id="sources_container" class="space-y-4"></div>
                            <button id="add_source_btn" class="mt-4 bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition text-sm">+ 출처 추가</button>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Tab 5: 미리보기 및 제출 -->
            <div id="tab5" class="tab-content">
                 <div class="bg-white p-6 sm:p-8 rounded-lg shadow-md mb-6 no-print">
                    <!-- [MODIFIED] Button container -->
                    <div class="flex justify-center items-center gap-4 flex-wrap">
                        <button id="download_zip_btn" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition text-base">
                            📦 ZIP으로 다운로드
                        </button>
                        <button id="print_btn" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition text-base">
                            🖨️ PDF로 저장
                        </button>
                        <button id="preview_newtab_btn" class="bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition text-base">
                            👁️ 미리보기(새 탭)
                        </button>
                        <button id="retry_upload_btn" class="hidden bg-yellow-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-yellow-600 transition text-base">
                            🔄 업로드 재시도
                        </button>
                    </div>
                    <p class="text-center text-sm text-gray-600 mt-4" aria-live="polite" role="status"><span id="submit_status"></span></p>
                    <div class="text-center mt-2">
                        <span id="online-status" class="text-green-600 text-sm">온라인</span>
                    </div>
                    <div id="progress_container" class="w-full max-w-xl mx-auto mt-3 hidden" aria-hidden="true">
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div id="progress_bar" class="bg-indigo-600 h-3 rounded-full transition-all duration-300" style="width:0%"></div>
                        </div>
                        <p id="progress_text" class="text-center text-xs text-gray-600 mt-1"></p>
                        <p id="progress_details" class="text-center text-xs text-gray-500 mt-1 hidden"></p>
                    </div>
                </div>
                <div class="bg-gray-200 p-4 sm:p-8 rounded-lg">
                    <div class="printable-area report-page" id="report-content">
                        <h1 id="preview_main_title" class="report-main-title">스마트 모빌리티 허브 아이디어 제안서</h1>
                        <p class="text-right text-gray-600 mb-10" style="font-family: 'Noto Sans KR', sans-serif;">
                            <span id="preview_student_grade">1</span>학년 <span id="preview_student_class">0</span>반 <span id="preview_student_number">00</span>번 이름: <span id="preview_student_name">ㅇㅇㅇ</span>
                        </p>
                        
                        <h2 class="report-section-title">I. 현황 분석 및 문제 인식</h2>
                        <p class="preview-text" id="preview_analysis"><span class="preview-placeholder">내용을 입력하세요...</span></p>

                        <h2 class="report-section-title">II. 시범사업 대상지 선정을 위한 고려사항</h2>
                        <h3 class="font-semibold mt-4 mb-2" id="preview_c1_title" style="font-family: 'Noto Sans KR', sans-serif;"><span class="preview-placeholder">[고려사항 1 제목]</span></h3>
                        <p class="preview-text" id="preview_c1_desc"><span class="preview-placeholder">내용을 입력하세요...</span></p>
                        <h3 class="font-semibold mt-4 mb-2" id="preview_c2_title" style="font-family: 'Noto Sans KR', sans-serif;"><span class="preview-placeholder">[고려사항 2 제목]</span></h3>
                        <p class="preview-text" id="preview_c2_desc"><span class="preview-placeholder">내용을 입력하세요...</span></p>

                        <h2 class="report-section-title">III. 스마트 모빌리티 허브 아이디어</h2>
                        <h3 class="font-semibold mt-4 mb-2" style="font-family: 'Noto Sans KR', sans-serif;">가. 물리적 인프라 (공간)</h3>
                        <p class="preview-text" id="preview_idea_infra"><span class="preview-placeholder">내용을 입력하세요...</span></p>
                        <h3 class="font-semibold mt-4 mb-2" style="font-family: 'Noto Sans KR', sans-serif;">나. 디지털/정책 (혜택)</h3>
                        <p class="preview-text" id="preview_idea_policy"><span class="preview-placeholder">내용을 입력하세요...</span></p>
                        <h3 class="font-semibold mt-4 mb-2" style="font-family: 'Noto Sans KR', sans-serif;">다. 운영 모델 (협력)</h3>
                        <p class="preview-text" id="preview_idea_operation"><span class="preview-placeholder">내용을 입력하세요...</span></p>

                        <h2 class="report-section-title">IV. 기대 효과</h2>
                        <p class="preview-text" id="preview_effects"><span class="preview-placeholder">내용을 입력하세요...</span></p>

                        <h2 class="report-section-title">V. 정보 출처</h2>
                        <div class="preview-text" id="preview_sources"><span class="preview-placeholder">내용을 입력하세요...</span></div>

                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals and Toasts -->
    <div id="toast-notification" class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 no-print">
        저장되었습니다!
    </div>
    <div id="delete-confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50 no-print">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold text-gray-800">작성한 내용을 삭제하시겠습니까?</h3>
            <p class="text-gray-600 mt-2">이 작업은 되돌릴 수 없습니다.</p>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">취소</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">삭제</button>
            </div>
        </div>
    </div>
    <!-- [NEW] Import Modal -->
    <div id="import-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50 no-print">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h3 class="text-lg font-bold text-gray-800">데이터 가져오기</h3>
            <p class="text-gray-600 mt-2">'데이터 내보내기'로 복사한 텍스트를 아래에 붙여넣고 '불러오기' 버튼을 누르세요.</p>
            <textarea id="import_textarea" class="w-full h-32 p-2 mt-4 border border-gray-300 rounded-md"></textarea>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="cancel-import-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">취소</button>
                <button id="confirm-import-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">불러오기</button>
            </div>
        </div>
    </div>

    <!-- [NEW] iOS Save Help Modal -->
    <div id="ios-help-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50 no-print" role="dialog" aria-modal="true" aria-labelledby="ios-help-title">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h3 id="ios-help-title" class="text-lg font-bold text-gray-800">iOS에서 ZIP 파일 저장하기</h3>
            <ol class="text-gray-700 mt-3 list-decimal list-inside space-y-2">
                <li>아래 "파일에 저장(공유 시트)" 버튼을 눌러 공유 시트를 여세요.</li>
                <li>공유 시트에서 "파일에 저장"을 선택하세요.</li>
                <li>원하는 저장 위치(예: iCloud Drive 또는 내 iPhone)와 폴더를 선택하고 저장하세요.</li>
            </ol>
            <p class="text-gray-500 text-sm mt-3">팁: 저장 후 "파일" 앱에서 방금 저장한 위치로 이동해 확인할 수 있어요.</p>
            <div class="mt-6 flex flex-col sm:flex-row justify-end gap-3">
                <button id="ios-help-download-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">대신 바로 다운로드</button>
                <div class="flex-1"></div>
                <button id="ios-help-close-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">닫기</button>
                <button id="ios-help-confirm-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">파일에 저장(공유 시트)</button>
            </div>
        </div>
    </div>

    <!-- [NEW] Mobile Download Center Modal -->
    <div id="inapp-download-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50 no-print" role="dialog" aria-modal="true" aria-labelledby="inapp-title">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h3 id="inapp-title" class="text-lg font-bold text-gray-800">모바일 브라우저에서 저장하기</h3>
            <p class="text-gray-600 mt-2">현재 사용 중인 브라우저에서는 파일 저장이 제한될 수 있어요. 아래 버튼으로 서버에서 직접 내려받아 주세요.</p>
            <div class="mt-4 grid grid-cols-1 gap-3">
                <button id="inapp-server-download-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">서버에서 다운로드(권장)</button>
                <button id="inapp-retry-btn" class="hidden px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">재시도</button>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="inapp-close-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">닫기</button>
            </div>
        </div>
    </div>


    <script type="module">
    import { ProgressManager, ToastManager, ModalManager, StatusManager, EnvironmentDetector } from './modules/ui-utils.js';
    import { FileProcessor, FilenameGenerator, DocumentGenerator, DownloadManager } from './modules/file-utils.js';
    import { UploadManager } from './modules/upload-manager.js';
    import { imageUploadManager } from './modules/image-processor.js';
    
    // Service Worker 등록
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then((registration) => {
                    console.log('Service Worker registered successfully:', registration.scope);
                })
                .catch((error) => {
                    console.log('Service Worker registration failed:', error);
                });
        });
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        // --- 모듈 인스턴스 생성 ---
        const progressManager = new ProgressManager();
        const toastManager = new ToastManager();
        const modalManager = new ModalManager();
        const statusManager = new StatusManager();
        const downloadManager = new DownloadManager(progressManager, toastManager, statusManager);
        const uploadManager = new UploadManager(progressManager, toastManager, statusManager, downloadManager);

        // --- DOM Element Constants ---
        const dom = {
            tabs: document.querySelectorAll('.tab-button'),
            tabContents: document.querySelectorAll('.tab-content'),
            accordions: document.querySelectorAll('.accordion-header button'),
            deleteAllBtn: document.getElementById('delete_all_btn'),
            deleteModal: document.getElementById('delete-confirm-modal'),
            confirmDeleteBtn: document.getElementById('confirm-delete-btn'),
            cancelDeleteBtn: document.getElementById('cancel-delete-btn'),
            downloadZipBtn: document.getElementById('download_zip_btn'),
            printBtn: document.getElementById('print_btn'),
            previewNewTabBtn: document.getElementById('preview_newtab_btn'),
            retryUploadBtn: document.getElementById('retry_upload_btn'),
            addSourceBtn: document.getElementById('add_source_btn'),
            sourcesContainer: document.getElementById('sources_container'),
            toast: document.getElementById('toast-notification'),
            allInputs: document.querySelectorAll('#tab4 input, #tab4 textarea, input#student_grade, input#student_class, input#student_number, input#student_name'),
            // Import/Export elements
            importDataBtn: document.getElementById('import_data_btn'),
            exportDataBtn: document.getElementById('export_data_btn'),
            importModal: document.getElementById('import-modal'),
            importTextarea: document.getElementById('import_textarea'),
            confirmImportBtn: document.getElementById('confirm-import-btn'),
            cancelImportBtn: document.getElementById('cancel-import-btn'),
            // Submit status
            submitStatus: document.getElementById('submit_status'),
            // iOS Help Modal
            iosHelpModal: document.getElementById('ios-help-modal'),
            iosHelpConfirmBtn: document.getElementById('ios-help-confirm-btn'),
            iosHelpCloseBtn: document.getElementById('ios-help-close-btn'),
            iosHelpDownloadBtn: document.getElementById('ios-help-download-btn'),
            // In-App Download Center
            inappModal: document.getElementById('inapp-download-modal'),
            inappCloseBtn: document.getElementById('inapp-close-btn'),
            inappServerDownloadBtn: document.getElementById('inapp-server-download-btn'),
            inappRetryBtn: document.getElementById('inapp-retry-btn'),
        };

        // --- 오프라인 상태 감지 및 알림 ---
        function updateOnlineStatus() {
            const isOnline = navigator.onLine;
            const statusIndicator = document.getElementById('online-status');
            
            if (statusIndicator) {
                if (isOnline) {
                    statusIndicator.textContent = '온라인';
                    statusIndicator.className = 'text-green-600 text-sm';
                } else {
                    statusIndicator.textContent = '오프라인';
                    statusIndicator.className = 'text-red-600 text-sm';
                    toastManager.show('인터넷 연결이 끊어졌습니다. 오프라인 모드로 전환됩니다.', 'bg-yellow-600');
                }
            }
        }

        // 온라인/오프라인 이벤트 리스너
        window.addEventListener('online', () => {
            updateOnlineStatus();
            toastManager.show('인터넷 연결이 복구되었습니다.', 'bg-green-600');
        });

        window.addEventListener('offline', () => {
            updateOnlineStatus();
        });

        // 초기 상태 설정
        updateOnlineStatus();

        // --- 탭 기능 초기화 ---
        initTabs();
        
        // --- 아코디언 기능 초기화 ---
        initAccordions();

        // --- 이벤트 리스너 설정 ---
        // Replace default ZIP download with simultaneous download + upload
        if (dom.downloadZipBtn) dom.downloadZipBtn.addEventListener('click', () => uploadManager.handleZipDownloadAndSubmit());
        if (dom.printBtn) dom.printBtn.addEventListener('click', printReport);
        if (dom.previewNewTabBtn) dom.previewNewTabBtn.addEventListener('click', openPreviewInNewTab);
        if (dom.retryUploadBtn) dom.retryUploadBtn.addEventListener('click', () => uploadManager.retryLastUpload());

        // iOS Help Modal events
        if (dom.iosHelpCloseBtn) dom.iosHelpCloseBtn.addEventListener('click', () => modalManager.hide(dom.iosHelpModal));
        if (dom.iosHelpDownloadBtn) dom.iosHelpDownloadBtn.addEventListener('click', () => {
            // Fallback direct download
            if (downloadManager.lastZipBlob && downloadManager.lastMeta?.zipFilename) {
                FileProcessor.triggerBlobDownload(downloadManager.lastZipBlob, downloadManager.lastMeta.zipFilename);
            }
            modalManager.hide(dom.iosHelpModal);
        });
        if (dom.iosHelpConfirmBtn) dom.iosHelpConfirmBtn.addEventListener('click', openIOSShare);

        // In-App Download Center events
        if (dom.inappCloseBtn) dom.inappCloseBtn.addEventListener('click', () => modalManager.hide(dom.inappModal));
        if (dom.inappServerDownloadBtn) dom.inappServerDownloadBtn.addEventListener('click', () => {
            downloadManager.serverDownloadLastZip();
        });
        if (dom.inappRetryBtn) dom.inappRetryBtn.addEventListener('click', () => {
            downloadManager.serverDownloadLastZip(true);
        });

        // Close modals on ESC for accessibility
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (dom.iosHelpModal && !dom.iosHelpModal.classList.contains('hidden')) modalManager.hide(dom.iosHelpModal);
                if (dom.inappModal && !dom.inappModal.classList.contains('hidden')) modalManager.hide(dom.inappModal);
            }
        });

        // Import/Export event listeners
        if (dom.importDataBtn) dom.importDataBtn.addEventListener('click', () => dom.importModal.classList.remove('hidden'));
        if (dom.exportDataBtn) dom.exportDataBtn.addEventListener('click', exportData);
        if (dom.cancelImportBtn) dom.cancelImportBtn.addEventListener('click', () => dom.importModal.classList.add('hidden'));
        if (dom.confirmImportBtn) dom.confirmImportBtn.addEventListener('click', importData);

        // --- 기존 함수들 (간소화) ---
        function printReport() { 
            const originalTitle = document.title; 
            document.title = FilenameGenerator.getReportFilename(); 
            window.print(); 
            setTimeout(() => { document.title = originalTitle; }, 500); 
        }

        function openPreviewInNewTab() {
            const reportContent = document.getElementById('report-content').innerHTML;
            const docHtml = DocumentGenerator.generateDocHtml(FilenameGenerator.getReportFilename(), reportContent);
            const newWindow = window.open('', '_blank');
            newWindow.document.write(docHtml);
            newWindow.document.close();
        }

        function openIOSShare() {
            if (downloadManager.lastZipBlob && downloadManager.lastMeta?.zipFilename) {
                const shareData = {
                    title: '스마트 모빌리티 허브 아이디어 제안서',
                    text: '과학탐구실험2 수행평가 제출 파일',
                    files: [new File([downloadManager.lastZipBlob], downloadManager.lastMeta.zipFilename, { type: 'application/zip' })]
                };
                
                if (navigator.canShare && navigator.canShare(shareData)) {
                    navigator.share(shareData).catch(() => {
                        toastManager.show('공유에 실패했습니다.', 'bg-red-500');
                    });
                } else {
                    toastManager.show('공유 기능을 사용할 수 없습니다.', 'bg-red-500');
                }
            }
            modalManager.hide(dom.iosHelpModal);
        }

        async function exportData() {
            const dataString = localStorage.getItem('suhaeng3_data');
            if (!dataString) {
                toastManager.show('저장된 데이터가 없습니다.', 'bg-red-500');
                return;
            }
            try {
                if (navigator.clipboard?.writeText) {
                    await navigator.clipboard.writeText(dataString);
                    toastManager.show('데이터가 클립보드에 복사되었습니다.');
                } else {
                    throw new Error('Clipboard API not available');
                }
            } catch (err) {
                // Fallback
                const tempTextarea = document.createElement('textarea');
                tempTextarea.value = dataString;
                document.body.appendChild(tempTextarea);
                tempTextarea.select();
                try {
                    document.execCommand('copy');
                    toastManager.show('데이터가 클립보드에 복사되었습니다.');
                } catch (e) {
                    toastManager.show('복사에 실패했습니다. 직접 복사해주세요.', 'bg-red-500');
                    prompt('아래 텍스트를 직접 복사하세요:', dataString);
                }
                document.body.removeChild(tempTextarea);
            }
        }

        function importData() {
            const dataString = dom.importTextarea.value;
            if (!dataString.trim()) {
                toastManager.show('붙여넣을 데이터가 없습니다.', 'bg-red-500');
                return;
            }
            try {
                const data = JSON.parse(dataString);
                // Clear existing content before loading
                dom.allInputs.forEach(input => input.value = '');
                dom.sourcesContainer.innerHTML = '';

                // Load new data
                Object.entries(data).forEach(([key, value]) => {
                    if (key === 'sources' && Array.isArray(value)) {
                        value.forEach(source => addSourceElement(source));
                    } else {
                        const el = document.getElementById(key);
                        if (el) el.value = value;
                    }
                });
                
                updatePreviewAndSave(); // Save imported data to the current browser and update preview
                dom.importModal.classList.add('hidden');
                dom.importTextarea.value = '';
                toastManager.show('데이터를 성공적으로 불러왔습니다.');

            } catch (error) {
                toastManager.show('데이터 형식이 올바르지 않습니다.', 'bg-red-500');
            }
        }

        // 기타 필요한 함수들...
        function addSourceElement(sourceData = null) {
            // 간소화된 구현
            const entryDiv = document.createElement('div');
            entryDiv.className = 'source-entry border p-4 rounded-md bg-gray-50 space-y-3';
            entryDiv.innerHTML = '<div class="text-sm text-gray-600">출처 정보</div>';
            dom.sourcesContainer.appendChild(entryDiv);
        }

        function updatePreviewAndSave() {
            // 간소화된 구현
            localStorage.setItem('suhaeng3_data', JSON.stringify({}));
        }

        // --- 탭 기능 정의 ---
        function initTabs() {
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(btn => {
                btn.addEventListener('click', () => {
                    const target = btn.dataset.tab;
                    
                    // 모든 탭 버튼에서 active 클래스 제거
                    tabs.forEach(b => b.classList.remove('active'));
                    // 클릭된 버튼에 active 클래스 추가
                    btn.classList.add('active');
                    
                    // 모든 탭 콘텐츠에서 active 클래스 제거
                    contents.forEach(c => c.classList.remove('active'));
                    // 해당하는 콘텐츠에 active 클래스 추가
                    const targetContent = document.getElementById(target);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                    
                    // 페이지 상단으로 스크롤
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            });
        }
        
        // --- 아코디언 기능 정의 ---
        function initAccordions() {
            const accordionButtons = document.querySelectorAll('.accordion-header button');
            
            accordionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const content = button.nextElementSibling;
                    const isOpen = content.classList.contains('open');
                    
                    // 모든 아코디언 닫기
                    accordionButtons.forEach(btn => {
                        btn.classList.remove('open');
                        btn.nextElementSibling.classList.remove('open');
                    });
                    
                    // 클릭된 아코디언이 닫혀있었다면 열기
                    if (!isOpen) {
                        button.classList.add('open');
                        content.classList.add('open');
                    }
                });
            });
        }
    });
    </script>
</body>
</html>
